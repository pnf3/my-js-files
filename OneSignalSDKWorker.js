(function(){"use strict";function Bt(){return typeof PushSubscriptionOptions<"u"&&PushSubscriptionOptions.prototype.hasOwnProperty("applicationServerKey")}class R extends Error{constructor(e=""){super(e),Object.defineProperty(this,"message",{configurable:!0,enumerable:!1,value:e,writable:!0}),Object.defineProperty(this,"name",{configurable:!0,enumerable:!1,value:this.constructor.name,writable:!0}),Object.defineProperty(this,"stack",{configurable:!0,enumerable:!1,value:new Error(e).stack,writable:!0}),Object.setPrototypeOf(this,R.prototype)}}var w=(s=>(s[s.Empty=0]="Empty",s[s.Malformed=1]="Malformed",s[s.EnumOutOfRange=2]="EnumOutOfRange",s[s.WrongType=3]="WrongType",s))(w||{});class S extends R{argument;reason;constructor(e,t,i){let n;switch(t){case 0:n=`Supply a non-empty value to '${e}'. ${i}`;break;case 1:n=`The value for '${e}' was malformed. ${i}`;break;case 2:n=`The value for '${e}' was out of range of the expected input enum. ${i}`;break;case 3:n=`The value for '${e}' was of the wrong type. ${i}`;break}super(n),this.argument=e,this.reason=w[t],Object.setPrototypeOf(this,S.prototype)}}var D=(s=>(s.Development="Development",s.Staging="Staging",s.Production="Production",s))(D||{}),W=(s=>(s.ServiceWorker="ServiceWorker",s.Host="Host",s))(W||{});const $t=4001,_t=3e3,jt=18080,Ht=["outcomes","on_focus"];class k{static getBuildEnv(){return D.Production}static getApiEnv(){return D.Production}static getOrigin(){return O.isBrowser()?window.location.origin:typeof self<"u"&&typeof ServiceWorkerGlobalScope<"u"?self.location.origin:"Unknown"}static getWindowEnv(){if(typeof self<"u"&&typeof ServiceWorkerGlobalScope<"u")return W.ServiceWorker;if(typeof window>"u")throw Error("OneSignalSDK: Unsupported JS runtime!");return W.Host}static getBuildEnvPrefix(e=k.getBuildEnv()){switch(e){case D.Development:return"Dev-";case D.Staging:return"Staging-";case D.Production:return"";default:throw new S("buildEnv",w.EnumOutOfRange)}}static getOneSignalApiUrl(e=k.getApiEnv(),t){const i="localhost";switch(e){case D.Development:return k.isTurbineEndpoint(t)?new URL(`http://${i}:${jt}/api/v1`):new URL(`http://${i}:${_t}/api/v1`);case D.Staging:return new URL(`https://${i}/api/v1`);case D.Production:return new URL("https://onesignal.com/api/v1");default:throw new S("buildEnv",w.EnumOutOfRange)}}static getOneSignalStaticResourcesUrl(){return new URL("https://media.onesignal.com/web-sdk")}static getOneSignalResourceUrlPath(e=k.getBuildEnv()){const t="localhost";let i;const n="https",a=$t;switch(e){case D.Development:i=`${n}://${t}:${a}`;break;case D.Staging:i=`https://${t}`;break;case D.Production:i="https://onesignal.com";break;default:throw new S("buildEnv",w.EnumOutOfRange)}return new URL(`${i}/sdks/web/v16`)}static getOneSignalCssFileName(e=k.getBuildEnv()){const t="OneSignalSDK.page.styles.css";switch(e){case D.Development:return`Dev-${t}`;case D.Staging:return`Staging-${t}`;case D.Production:return t;default:throw new S("buildEnv",w.EnumOutOfRange)}}static isTurbineEndpoint(e){return e?Ht.some(t=>e.indexOf(t)>-1):!1}}function zt(s){return s&&s.__esModule&&Object.prototype.hasOwnProperty.call(s,"default")?s.default:s}var Me={exports:{}};/*!
 * Bowser - a browser detector
 * https://github.com/ded/bowser
 * MIT License | (c) Dustin Diaz 2015
 */var qt=Me.exports,mt;function Gt(){return mt||(mt=1,function(s){(function(e,t,i){s.exports?s.exports=i():e[t]=i()})(qt,"bowser",function(){var e=!0;function t(u){function d(Ue){var be=u.match(Ue);return be&&be.length>1&&be[1]||""}function m(Ue){var be=u.match(Ue);return be&&be.length>1&&be[2]||""}var y=d(/(ipod|iphone|ipad)/i).toLowerCase(),T=/like android/i.test(u),C=!T&&/android/i.test(u),qe=/nexus\s*[0-6]\s*/i.test(u),Ge=!qe&&/nexus\s*[0-9]+/i.test(u),E=/CrOS/.test(u),B=/silk/i.test(u),Oe=/sailfish/i.test(u),Ie=/tizen/i.test(u),H=/(web|hpw)os/i.test(u),Wt=/windows phone/i.test(u),Ci=!Wt&&/windows/i.test(u),Ui=!y&&!B&&/macintosh/i.test(u),Mi=!C&&!Oe&&!Ie&&!H&&/linux/i.test(u),bt=d(/edge\/(\d+(\.\d+)?)/i),N=d(/version\/(\d+(\.\d+)?)/i),Vt=/tablet/i.test(u)&&!/tablet pc/i.test(u),Lt=!Vt&&/[^-]mobi/i.test(u),Di=/xbox/i.test(u),c;/opera/i.test(u)?c={name:"Opera",opera:e,version:N||d(/(?:opera|opr|opios)[\s\/](\d+(\.\d+)?)/i)}:/opr\/|opios/i.test(u)?c={name:"Opera",opera:e,version:d(/(?:opr|opios)[\s\/](\d+(\.\d+)?)/i)||N}:/SamsungBrowser/i.test(u)?c={name:"Samsung Internet for Android",samsungBrowser:e,version:N||d(/(?:SamsungBrowser)[\s\/](\d+(\.\d+)?)/i)}:/coast/i.test(u)?c={name:"Opera Coast",coast:e,version:N||d(/(?:coast)[\s\/](\d+(\.\d+)?)/i)}:/yabrowser/i.test(u)?c={name:"Yandex Browser",yandexbrowser:e,version:N||d(/(?:yabrowser)[\s\/](\d+(\.\d+)?)/i)}:/ucbrowser/i.test(u)?c={name:"UC Browser",ucbrowser:e,version:d(/(?:ucbrowser)[\s\/](\d+(?:\.\d+)+)/i)}:/mxios/i.test(u)?c={name:"Maxthon",maxthon:e,version:d(/(?:mxios)[\s\/](\d+(?:\.\d+)+)/i)}:/epiphany/i.test(u)?c={name:"Epiphany",epiphany:e,version:d(/(?:epiphany)[\s\/](\d+(?:\.\d+)+)/i)}:/puffin/i.test(u)?c={name:"Puffin",puffin:e,version:d(/(?:puffin)[\s\/](\d+(?:\.\d+)?)/i)}:/sleipnir/i.test(u)?c={name:"Sleipnir",sleipnir:e,version:d(/(?:sleipnir)[\s\/](\d+(?:\.\d+)+)/i)}:/k-meleon/i.test(u)?c={name:"K-Meleon",kMeleon:e,version:d(/(?:k-meleon)[\s\/](\d+(?:\.\d+)+)/i)}:Wt?(c={name:"Windows Phone",windowsphone:e},bt?(c.msedge=e,c.version=bt):(c.msie=e,c.version=d(/iemobile\/(\d+(\.\d+)?)/i))):/msie|trident/i.test(u)?c={name:"Internet Explorer",msie:e,version:d(/(?:msie |rv:)(\d+(\.\d+)?)/i)}:E?c={name:"Chrome",chromeos:e,chromeBook:e,chrome:e,version:d(/(?:chrome|crios|crmo)\/(\d+(\.\d+)?)/i)}:/chrome.+? edge/i.test(u)?c={name:"Microsoft Edge",msedge:e,version:bt}:/vivaldi/i.test(u)?c={name:"Vivaldi",vivaldi:e,version:d(/vivaldi\/(\d+(\.\d+)?)/i)||N}:Oe?c={name:"Sailfish",sailfish:e,version:d(/sailfish\s?browser\/(\d+(\.\d+)?)/i)}:/seamonkey\//i.test(u)?c={name:"SeaMonkey",seamonkey:e,version:d(/seamonkey\/(\d+(\.\d+)?)/i)}:/firefox|iceweasel|fxios/i.test(u)?(c={name:"Firefox",firefox:e,version:d(/(?:firefox|iceweasel|fxios)[ \/](\d+(\.\d+)?)/i)},/\((mobile|tablet);[^\)]*rv:[\d\.]+\)/i.test(u)&&(c.firefoxos=e)):B?c={name:"Amazon Silk",silk:e,version:d(/silk\/(\d+(\.\d+)?)/i)}:/phantom/i.test(u)?c={name:"PhantomJS",phantom:e,version:d(/phantomjs\/(\d+(\.\d+)?)/i)}:/slimerjs/i.test(u)?c={name:"SlimerJS",slimer:e,version:d(/slimerjs\/(\d+(\.\d+)?)/i)}:/blackberry|\bbb\d+/i.test(u)||/rim\stablet/i.test(u)?c={name:"BlackBerry",blackberry:e,version:N||d(/blackberry[\d]+\/(\d+(\.\d+)?)/i)}:H?(c={name:"WebOS",webos:e,version:N||d(/w(?:eb)?osbrowser\/(\d+(\.\d+)?)/i)},/touchpad\//i.test(u)&&(c.touchpad=e)):/bada/i.test(u)?c={name:"Bada",bada:e,version:d(/dolfin\/(\d+(\.\d+)?)/i)}:Ie?c={name:"Tizen",tizen:e,version:d(/(?:tizen\s?)?browser\/(\d+(\.\d+)?)/i)||N}:/qupzilla/i.test(u)?c={name:"QupZilla",qupzilla:e,version:d(/(?:qupzilla)[\s\/](\d+(?:\.\d+)+)/i)||N}:/chromium/i.test(u)?c={name:"Chromium",chromium:e,version:d(/(?:chromium)[\s\/](\d+(?:\.\d+)?)/i)||N}:/chrome|crios|crmo/i.test(u)?c={name:"Chrome",chrome:e,version:d(/(?:chrome|crios|crmo)\/(\d+(\.\d+)?)/i)}:C?c={name:"Android",version:N}:/safari|applewebkit/i.test(u)?(c={name:"Safari",safari:e},N&&(c.version=N)):y?(c={name:y=="iphone"?"iPhone":y=="ipad"?"iPad":"iPod"},N&&(c.version=N)):/googlebot/i.test(u)?c={name:"Googlebot",googlebot:e,version:d(/googlebot\/(\d+(\.\d+))/i)||N}:c={name:d(/^(.*)\/(.*) /),version:m(/^(.*)\/(.*) /)},!c.msedge&&/(apple)?webkit/i.test(u)?(/(apple)?webkit\/537\.36/i.test(u)?(c.name=c.name||"Blink",c.blink=e):(c.name=c.name||"Webkit",c.webkit=e),!c.version&&N&&(c.version=N)):!c.opera&&/gecko\//i.test(u)&&(c.name=c.name||"Gecko",c.gecko=e,c.version=c.version||d(/gecko\/(\d+(\.\d+)?)/i)),!c.windowsphone&&!c.msedge&&(C||c.silk)?c.android=e:!c.windowsphone&&!c.msedge&&y?(c[y]=e,c.ios=e):Ui?c.mac=e:Di?c.xbox=e:Ci?c.windows=e:Mi&&(c.linux=e);function Ri(Ue){switch(Ue){case"NT":return"NT";case"XP":return"XP";case"NT 5.0":return"2000";case"NT 5.1":return"XP";case"NT 5.2":return"2003";case"NT 6.0":return"Vista";case"NT 6.1":return"7";case"NT 6.2":return"8";case"NT 6.3":return"8.1";case"NT 10.0":return"10";default:return}}var M="";c.windows?M=Ri(d(/Windows ((NT|XP)( \d\d?.\d)?)/i)):c.windowsphone?M=d(/windows phone (?:os)?\s?(\d+(\.\d+)*)/i):c.mac?(M=d(/Mac OS X (\d+([_\.\s]\d+)*)/i),M=M.replace(/[_\s]/g,".")):y?(M=d(/os (\d+([_\s]\d+)*) like mac os x/i),M=M.replace(/[_\s]/g,".")):C?M=d(/android[ \/-](\d+(\.\d+)*)/i):c.webos?M=d(/(?:web|hpw)os\/(\d+(\.\d+)*)/i):c.blackberry?M=d(/rim\stablet\sos\s(\d+(\.\d+)*)/i):c.bada?M=d(/bada\/(\d+(\.\d+)*)/i):c.tizen&&(M=d(/tizen[\/\s](\d+(\.\d+)*)/i)),M&&(c.osversion=M);var Ft=!c.windows&&M.split(".")[0];return Vt||Ge||y=="ipad"||C&&(Ft==3||Ft>=4&&!Lt)||c.silk?c.tablet=e:(Lt||y=="iphone"||y=="ipod"||C||qe||c.blackberry||c.webos||c.bada)&&(c.mobile=e),c.msedge||c.msie&&c.version>=10||c.yandexbrowser&&c.version>=15||c.vivaldi&&c.version>=1||c.chrome&&c.version>=20||c.samsungBrowser&&c.version>=4||c.firefox&&c.version>=20||c.safari&&c.version>=6||c.opera&&c.version>=10||c.ios&&c.osversion&&c.osversion.split(".")[0]>=6||c.blackberry&&c.version>=10.1||c.chromium&&c.version>=20?c.a=e:c.msie&&c.version<10||c.chrome&&c.version<20||c.firefox&&c.version<20||c.safari&&c.version<6||c.opera&&c.version<10||c.ios&&c.osversion&&c.osversion.split(".")[0]<6||c.chromium&&c.version<20?c.c=e:c.x=e,c}var i=t(typeof navigator<"u"&&navigator.userAgent||"");i.test=function(u){for(var d=0;d<u.length;++d){var m=u[d];if(typeof m=="string"&&m in i)return!0}return!1};function n(u){return u.split(".").length}function a(u,d){var m=[],y;if(Array.prototype.map)return Array.prototype.map.call(u,d);for(y=0;y<u.length;y++)m.push(d(u[y]));return m}function o(u){for(var d=Math.max(n(u[0]),n(u[1])),m=a(u,function(y){var T=d-n(y);return y=y+new Array(T+1).join(".0"),a(y.split("."),function(C){return new Array(20-C.length).join("0")+C}).reverse()});--d>=0;){if(m[0][d]>m[1][d])return 1;if(m[0][d]===m[1][d]){if(d===0)return 0}else return-1}}function r(u,d,m){var y=i;typeof d=="string"&&(m=d,d=void 0),d===void 0&&(d=!1),m&&(y=t(m));var T=""+y.version;for(var C in u)if(u.hasOwnProperty(C)&&y[C]){if(typeof u[C]!="string")throw new Error("Browser version in the minVersion map should be a string: "+C+": "+String(u));return o([T,u[C]])<0}return d}function p(u,d,m){return!r(u,d,m)}return i.isUnsupportedBrowser=r,i.compareVersions=o,i.check=p,i._detect=t,i})}(Me)),Me.exports}var ke=Gt();const Ke=zt(ke);function V(){return{mobile:ke.mobile,tablet:ke.tablet,name:ke.name.toLowerCase(),version:ke.version}}class O{static isBrowser(){return typeof window<"u"}static useSafariLegacyPush(){return this.isBrowser()&&window.safari?.pushNotification!=null}static useSafariVapidPush(){return V().name=="safari"&&Bt()&&!this.useSafariLegacyPush()}static version(){return 160306}static get TRADITIONAL_CHINESE_LANGUAGE_TAG(){return["tw","hant"]}static get SIMPLIFIED_CHINESE_LANGUAGE_TAG(){return["cn","hans"]}static getLanguage(){let e=navigator.language;if(e){e=e.toLowerCase();const t=e.split("-");if(t[0]=="zh"){for(const i of O.TRADITIONAL_CHINESE_LANGUAGE_TAG)if(t.indexOf(i)!==-1)return"zh-Hant";for(const i of O.SIMPLIFIED_CHINESE_LANGUAGE_TAG)if(t.indexOf(i)!==-1)return"zh-Hans";return"zh-Hant"}else return t[0].substring(0,2)}else return"en"}static supportsServiceWorkers(){switch(k.getWindowEnv()){case W.ServiceWorker:return!0;default:return typeof navigator<"u"&&"serviceWorker"in navigator}}}let g=class re{static debug;static trace;static info;static warn;static error;static proxyMethodsCreated;static shouldLog(){try{if(typeof window>"u"||typeof window.localStorage>"u")return!1;const e=window.localStorage.getItem("loglevel");return!!(e&&e.toLowerCase()==="trace")}catch{return!1}}static setLevel(e){if(!(typeof window>"u"||typeof window.localStorage>"u"))try{window.localStorage.setItem("loglevel",e),re.proxyMethodsCreated=void 0,re.createProxyMethods()}catch{return}}static createProxyMethods(){if(typeof re.proxyMethodsCreated<"u")return;re.proxyMethodsCreated=!0;const e={log:"debug",trace:"trace",info:"info",warn:"warn",error:"error"};for(const t of Object.keys(e)){const i=typeof console[t]<"u",n=e[t];i&&(re.shouldLog()||n==="error")?re[n]=console[t].bind(console):re[n]=function(){}}}};g.createProxyMethods();class Pe{static async getRegistration(e){try{const t=location.origin+e;return await navigator.serviceWorker.getRegistration(t)}catch(t){g.warn("[Service Worker Status] Error Checking service worker registration",e,t);return}}static getAvailableServiceWorker(e){const t=e.active||e.installing||e.waiting;return t||g.warn("Could not find an available ServiceWorker instance!"),t}static waitUntilActive(e){return new Promise(t=>{const i=e.installing||e.waiting;i&&i.addEventListener("statechange",()=>{g.debug("OneSignal Service Worker state changed:",i.state),e.active&&t()}),e.active&&t()})}}var P=(s=>(s.WorkerVersion="GetWorkerVersion",s.Subscribe="Subscribe",s.SubscribeNew="SubscribeNew",s.NotificationWillDisplay="notification.willDisplay",s.NotificationClicked="notification.clicked",s.NotificationDismissed="notification.dismissed",s.RedirectPage="command.redirect",s.SessionUpsert="os.session.upsert",s.SessionDeactivate="os.session.deactivate",s.AreYouVisible="os.page_focused_request",s.AreYouVisibleResponse="os.page_focused_response",s.SetLogging="os.set_sw_logging",s))(P||{});class Kt{replies;constructor(){this.replies={}}addListener(e,t,i){const n={callback:t,onceListenerOnly:i},a=this.replies[e.toString()];a?a.push(n):this.replies[e.toString()]=[n]}findListenersForMessage(e){return this.replies[e.toString()]||[]}deleteListenerRecords(e){this.replies[e.toString()]=null}deleteAllListenerRecords(){this.replies={}}deleteListenerRecord(e,t){const i=this.replies[e.toString()];if(i!=null)for(let n=i.length-1;n>=0;n--)i[n]===t&&i.splice(n,1)}}class wt{context;replies;constructor(e,t=new Kt){this.context=e,this.replies=t}async broadcast(e,t){if(k.getWindowEnv()!==W.ServiceWorker)return;const i=await self.clients.matchAll({type:"window",includeUncontrolled:!0});for(const n of i)g.debug(`[Worker Messenger] [SW -> Page] Broadcasting '${e.toString()}' to window client ${n.url}.`),n.postMessage({command:e,payload:t})}async unicast(e,t,i){if(k.getWindowEnv()===W.ServiceWorker)if(i)g.debug(`[Worker Messenger] [SW -> Page] Unicasting '${e.toString()}' to window client ${i.url}.`),i.postMessage({command:e,payload:t});else throw new S("windowClient",w.Empty);else g.debug(`[Worker Messenger] [Page -> SW] Unicasting '${e.toString()}' to service worker.`),this.directPostMessageToSW(e,t)}async directPostMessageToSW(e,t){g.debug(`[Worker Messenger] [Page -> SW] Direct command '${e.toString()}' to service worker.`);const i=await this.context?.serviceWorkerManager.getOneSignalRegistration();if(!i){g.error("`[Worker Messenger] [Page -> SW] Could not get ServiceWorkerRegistration to postMessage!");return}const n=Pe.getAvailableServiceWorker(i);if(!n){g.error("`[Worker Messenger] [Page -> SW] Could not get ServiceWorker to postMessage!");return}n.postMessage({command:e,payload:t})}async listen(){if(!O.supportsServiceWorkers())return;k.getWindowEnv()===W.ServiceWorker?(self.addEventListener("message",this.onWorkerMessageReceivedFromPage.bind(this)),g.debug("[Worker Messenger] Service worker is now listening for messages.")):await this.listenForPage()}async listenForPage(){navigator.serviceWorker.addEventListener("message",this.onPageMessageReceivedFromServiceWorker.bind(this)),g.debug(`(${location.origin}) [Worker Messenger] Page is now listening for messages.`)}onWorkerMessageReceivedFromPage(e){const t=e.data;if(!t||!t.command)return;const i=this.replies.findListenersForMessage(t.command),n=[],a=[];g.debug("[Worker Messenger] Service worker received message:",e.data);for(const o of i)o.onceListenerOnly&&n.push(o),a.push(o);for(let o=n.length-1;o>=0;o--){const r=n[o];this.replies.deleteListenerRecord(t.command,r)}for(const o of a)o.callback.apply(null,[t.payload])}onPageMessageReceivedFromServiceWorker(e){const t=e.data;if(!t||!t.command)return;const i=this.replies.findListenersForMessage(t.command),n=[],a=[];g.debug("[Worker Messenger] Page received message:",e.data);for(const o of i)o.onceListenerOnly&&n.push(o),a.push(o);for(let o=n.length-1;o>=0;o--){const r=n[o];this.replies.deleteListenerRecord(t.command,r)}for(const o of a)o.callback.apply(null,[t.payload])}on(e,t){this.replies.addListener(e,t,!1)}once(e,t){this.replies.addListener(e,t,!0)}off(e){e?this.replies.deleteListenerRecords(e):this.replies.deleteAllListenerRecords()}}const Yt="isOptedOut",Jt="isPushNotificationsEnabled",St="os_pageViews",yt="requiresPrivacyConsent";class vt{static removeLegacySubscriptionOptions(){localStorage.removeItem(Yt),localStorage.removeItem(Jt)}static setConsentRequired(e){localStorage.setItem(yt,e.toString())}static getConsentRequired(){return localStorage.getItem(yt)==="true"}static setLocalPageViewCount(e){localStorage.setItem(St,e.toString())}static getLocalPageViewCount(){return Number(localStorage.getItem(St))}}class De{static SESSION_STORAGE_KEY_NAME="onesignal-pageview-count";incrementedPageViewCount=!1;getPageViewCount(){try{const e=sessionStorage.getItem(De.SESSION_STORAGE_KEY_NAME),t=e?parseInt(e):0;return isNaN(t)?0:t}catch{return 0}}setPageViewCount(e){try{sessionStorage.setItem(De.SESSION_STORAGE_KEY_NAME,e.toString())}catch{}}incrementPageViewCount(){if(this.incrementedPageViewCount)return;const e=this.getPageViewCount()+1,t=this.getLocalPageViewCount()+1;this.setPageViewCount(e),this.setLocalPageViewCount(t),this.incrementedPageViewCount=!0,g.debug(`Incremented page view count: newCountSingleTab: ${e},
      newCountAccrossTabs: ${t}.`)}simulatePageNavigationOrRefresh(){this.incrementedPageViewCount=!1}isFirstPageView(){return this.getPageViewCount()===1}getLocalPageViewCount(){return vt.getLocalPageViewCount()}setLocalPageViewCount(e){vt.setLocalPageViewCount(e)}}class Ye{static get STORED_PERMISSION_KEY(){return"storedNotificationPermission"}async getPermissionStatus(){if(!OneSignal.context)throw new R("OneSignal.context is undefined. Make sure to call OneSignal.init() before calling getPermissionStatus().");return await OneSignal.context.permissionManager.getNotificationPermission(OneSignal.config.safariWebId)}async getNotificationPermission(e){return O.useSafariLegacyPush()?Ye.getLegacySafariNotificationPermission(e):this.getW3cNotificationPermission()}static getLegacySafariNotificationPermission(e){if(e)return window.safari.pushNotification.permission(e).permission;throw new S("safariWebId",w.Empty)}getW3cNotificationPermission(){return Notification.permission}}class Je extends R{constructor(e="The asynchronous operation has timed out."){super(e),this.message=e,Object.setPrototypeOf(this,Je.prototype)}}class b{static contains(e,t){return e?e.indexOf(t)!==-1:!1}static trimUndefined(e){for(const t in e)e[t]===void 0&&delete e[t];return e}static capitalize(e){return e.charAt(0).toUpperCase()+e.slice(1)}static isNullOrUndefined(e){return typeof e>"u"||e===null}static valueOrDefault(e,t){return typeof e>"u"||e===null?t:e}static stringify(e){return JSON.stringify(e,(t,i)=>typeof i=="function"?"[Function]":i,4)}static encodeHashAsUriComponent(e){let t="";const i=Object.keys(e);for(const n of i){const a=e[n];t+=`${encodeURIComponent(n)}=${encodeURIComponent(a)}`}return t}static timeoutPromise(e,t){const i=new Promise((n,a)=>{setTimeout(()=>{a(new Je)},t)});return Promise.race([e,i])}static getValueOrDefault(e,t){return e??t}static padStart(e,t,i){let n=e;for(;n.length<t;)n=i+n;return n}static parseVersionString(e){const t=e.toString().split("."),i=b.padStart(t[0],2,"0");let n;return t[1]?n=b.padStart(t[1],2,"0"):n="00",+`${i}.${n}`}static lastParts(e,t,i){const n=e.split(t),a=Math.max(n.length-i,0);return n.slice(a).join(t)}static enforceAppId(e){if(!e)throw new Error("App id cannot be empty")}static enforceAlias(e){if(!e.label)throw new Error("Alias label cannot be empty");if(!e.id)throw new Error("Alias id cannot be empty")}static sortArrayOfObjects(e,t,i=!1,n=!0){const a=n?e:e.slice();return a.sort((o,r)=>{const p=t(o),u=t(r);return p>u?i?-1:1:p<u?i?1:-1:0}),a}}class Re extends R{status;statusText;constructor(e,t){super("Registration of a Service Worker failed."),this.status=e,this.statusText=t,Object.setPrototypeOf(this,Re.prototype)}}var Ot=(s=>(s[s.Loaded=0]="Loaded",s[s.Failed=1]="Failed",s))(Ot||{});const K={containerClass:"onesignal-customlink-container",subscribeClass:"onesignal-customlink-subscribe",explanationClass:"onesignal-customlink-explanation",resetClass:"onesignal-reset",hide:"hide",state:{subscribed:"state-subscribed",unsubscribed:"state-unsubscribed"}},Qt={containerSelector:`.${K.containerClass}`};class z{static getBaseUrl(){return location.origin}static isLocalhostAllowedAsSecureOrigin(){return OneSignal.config&&OneSignal.config.userConfig&&OneSignal.config.userConfig.allowLocalhostAsSecureOrigin===!0}static redetectBrowserUserAgent(){return V().name===""&&V().version===""?Ke._detect(navigator.userAgent):Ke}static isValidUuid(e){return/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/.test(e)}static getRandomUuid(){const e=typeof window>"u"?global.crypto:window.crypto||window.msCrypto;return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(i){const n=e.getRandomValues(new Uint8Array(1))[0]%16|0;return(i=="x"?n:n&3|8).toString(16)})}static logMethodCall(e,...t){return g.debug(`Called ${e}(${t.map(b.stringify).join(", ")})`)}static isSafari(){return O.isBrowser()&&typeof window.safari<"u"}}class Qe{_events;constructor(){this._events={}}on(e,t){return this._events[e]=this._events[e]||[],this._events[e].push(t),this}once(e,t){const i=this;function n(){i.off(e,n),t.apply(this,arguments)}return n.listener=t,this.on(e,n),this}off(e,t){const i=this._events[e];if(i!==void 0){for(let n=0;n<i.length;n+=1)if(i[n]===t||i[n].listener===t){i.splice(n,1);break}i.length===0&&this.removeAllListeners(e)}return this}removeAllListeners(e){return e?delete this._events[e]:this._events={},this}listeners(e){try{return this._events[e]}catch{return}}numberOfListeners(e){const t=this.listeners(e);return t?t.length:0}async emit(...e){const t=e.shift();let i=this._events[t];if(i!==void 0){i=i.slice(0);const n=i.length;for(let a=0;a<n;a+=1)await i[a].apply(this,e)}return this}}var x=(s=>(s.Identity="identity",s.Properties="properties",s.Subscriptions="subscriptions",s))(x||{}),xe=(s=>(s.PushSubscriptions="pushSubscriptions",s.EmailSubscriptions="emailSubscriptions",s.SmsSubscriptions="smsSubscriptions",s))(xe||{});const Xt=6;class Zt{constructor(e,t=Xt){this.databaseName=e,this.dbVersion=t,this.emitter=new Qe}emitter;database;openLock;open(e){return new Promise(t=>{let i;try{i=indexedDB.open(e,this.dbVersion)}catch{}if(!i)return null;i.onerror=this.onDatabaseOpenError.bind(this),i.onblocked=this.onDatabaseOpenBlocked.bind(this),i.onupgradeneeded=this.onDatabaseUpgradeNeeded.bind(this),i.onsuccess=()=>{this.database=i.result,this.database.onerror=this.onDatabaseError,this.database.onversionchange=this.onDatabaseVersionChange,t(this.database)}})}async close(){(await this.ensureDatabaseOpen()).close(),this.database?.close()}async ensureDatabaseOpen(){return this.openLock||(this.openLock=this.open(this.databaseName)),await this.openLock}onDatabaseOpenError(e){e.preventDefault();const t=e.target.error;b.contains(t.message,"The operation failed for reasons unrelated to the database itself and not covered by any other error code")||b.contains(t.message,"A mutation operation was attempted on a database that did not allow mutations")?g.warn("OneSignal: IndexedDb web storage is not available on this origin since this profile's IndexedDb schema has been upgraded in a newer version of Firefox. See: https://bugzilla.mozilla.org/show_bug.cgi?id=1236557#c6"):g.warn("OneSignal: Fatal error opening IndexedDb database:",t)}objectStoreNames(){return Array.from(this.database?.objectStoreNames||[])}onDatabaseError(e){g.debug("IndexedDb: Generic database error",e.target.errorCode)}onDatabaseOpenBlocked(){g.debug("IndexedDb: Blocked event")}onDatabaseVersionChange(){g.debug("IndexedDb: versionchange event")}onDatabaseUpgradeNeeded(e){g.debug("IndexedDb: Database is being rebuilt or upgraded (upgradeneeded event).");const t=e.target,i=t.transaction;if(!i)throw Error("Can't migrate DB without a transaction");const n=t.result,a=e.newVersion||Number.MAX_SAFE_INTEGER;a>=1&&e.oldVersion<1&&(n.createObjectStore("Ids",{keyPath:"type"}),n.createObjectStore("NotificationOpened",{keyPath:"url"}),n.createObjectStore("Options",{keyPath:"key"})),a>=2&&e.oldVersion<2&&(n.createObjectStore("Sessions",{keyPath:"sessionKey"}),n.createObjectStore("NotificationReceived",{keyPath:"notificationId"}),n.createObjectStore("NotificationClicked",{keyPath:"notificationId"})),a>=3&&e.oldVersion<3&&n.createObjectStore("SentUniqueOutcome",{keyPath:"outcomeName"}),a>=4&&e.oldVersion<4&&(n.createObjectStore(x.Identity,{keyPath:"modelId"}),n.createObjectStore(x.Properties,{keyPath:"modelId"}),n.createObjectStore(xe.PushSubscriptions,{keyPath:"modelId"}),n.createObjectStore(xe.SmsSubscriptions,{keyPath:"modelId"}),n.createObjectStore(xe.EmailSubscriptions,{keyPath:"modelId"})),a>=5&&e.oldVersion<5&&(this.migrateOutcomesNotificationClickedTableForV5(n,i),this.migrateOutcomesNotificationReceivedTableForV5(n,i)),a>=6&&e.oldVersion<6&&this.migrateModelNameSubscriptionsTableForV6(n,i),a>=7&&e.oldVersion<7,typeof OneSignal<"u"&&(OneSignal._isNewVisitor=!0)}migrateOutcomesNotificationClickedTableForV5(e,t){const i="Outcomes.NotificationClicked";e.createObjectStore(i,{keyPath:"notificationId"});const n="NotificationClicked",a=t.objectStore(n).openCursor();a.onsuccess=()=>{if(!a.result){e.deleteObjectStore(n);return}const o=a.result.value;t.objectStore(i).put({notificationId:o.notificationId||o.notification.id,appId:o.appId,timestamp:o.timestamp}),a.result.continue()},a.onerror=()=>{console.error("Could not migrate NotificationClicked records",a.error)}}migrateOutcomesNotificationReceivedTableForV5(e,t){const i="Outcomes.NotificationReceived";e.createObjectStore(i,{keyPath:"notificationId"});const n="NotificationReceived",a=t.objectStore(n).openCursor();a.onsuccess=()=>{if(!a.result){e.deleteObjectStore(n);return}t.objectStore(i).put(a.result.value),a.result.continue()},a.onerror=()=>{console.error("Could not migrate NotificationReceived records",a.error)}}migrateModelNameSubscriptionsTableForV6(e,t){const i=x.Subscriptions;e.createObjectStore(i,{keyPath:"modelId"});let n;const a=t.objectStore(x.Identity).openCursor();a.onsuccess=()=>{a.result&&(n=a.result.value.externalId)},a.onerror=()=>{console.error("Could not find "+x.Identity+" records",a.error)},Object.values(xe).forEach(o=>{const r=t.objectStore(o).openCursor();r.onsuccess=()=>{if(!r.result){e.deleteObjectStore(o);return}const p=r.result.value;t.objectStore(i).put({...p,modelName:x.Subscriptions,externalId:n}),r.result.continue()},r.onerror=()=>{console.error("Could not migrate "+o+" records",r.error)}})}async dbOperation(e,t,i){const n=await this.ensureDatabaseOpen();return await new Promise((a,o)=>{try{const r=n.transaction(e,t==="get"||t==="getAll"?"readonly":"readwrite").objectStore(e),p=t==="getAll"||t==="clear"?r[t]():r[t](i);p.onsuccess=()=>{a(p.result)},p.onerror=u=>{g.error("Database "+t.toUpperCase()+" Transaction Error:",u),o(u)}}catch(r){g.error("Database "+t.toUpperCase()+" Error:",r),o(r)}})}async get(e,t){return t?this.dbOperation(e,"get",t):this.dbOperation(e,"getAll")}async getAll(e){return this.dbOperation(e,"getAll")}async put(e,t){return this.dbOperation(e,"put",t)}async remove(e,t){return t?this.dbOperation(e,"delete",t):this.dbOperation(e,"clear")}}class ei{defaultNotificationUrl;defaultNotificationTitle;lastKnownPushEnabled;lastKnownPushToken;lastKnownPushId;lastKnownOptedIn=!0;pendingNotificationClickEvents}class ti{previousOneSignalId;previousExternalId}class Xe{deviceId;subscriptionToken;optedOut;createdAt;expirationTime;serialize(){return{deviceId:this.deviceId,subscriptionToken:this.subscriptionToken,optedOut:this.optedOut,createdAt:this.createdAt,expirationTime:this.expirationTime}}static deserialize(e){const t=new Xe;return t.deviceId=e.deviceId,t.subscriptionToken=e.subscriptionToken,t.optedOut=e.optedOut,t.createdAt=e.createdAt,t.expirationTime=e.expirationTime,t}}var ce=(s=>(s.Active="active",s.Inactive="inactive",s))(ce||{}),We=(s=>(s[s.UserCreate=1]="UserCreate",s[s.UserNewSession=2]="UserNewSession",s[s.VisibilityVisible=3]="VisibilityVisible",s[s.VisibilityHidden=4]="VisibilityHidden",s[s.BeforeUnload=5]="BeforeUnload",s[s.PageRefresh=6]="PageRefresh",s[s.Focus=7]="Focus",s[s.Blur=8]="Blur",s))(We||{});const Ze="oneSignalSession";function It(s){const e=new Date().getTime(),t=s&&s.notificationId||null;return{accumulatedDuration:0,appId:s.appId,lastActivatedTimestamp:e,lastDeactivatedTimestamp:null,notificationId:t,sessionKey:Ze,startTimestamp:e,status:"active"}}class kt{static toDatabase(e){const t=e.notification,i=e.result;return{action:i.actionId,badge:t.badgeIcon,buttons:this.toDatabaseButtons(t.actionButtons),content:t.body,data:t.additionalData,heading:t.title,icon:t.icon,id:t.notificationId,image:t.image,rr:t.confirmDelivery,tag:t.topic,timestamp:e.timestamp,url:i.url}}static toDatabaseButtons(e){return e?.map(t=>({action:t.actionId,title:t.text,icon:t.icon,url:t.launchURL}))}static fromDatabase(e){return{result:{actionId:e.action,url:e.url},notification:{notificationId:e.id,title:e.heading,body:e.content,additionalData:e.data,launchURL:e.url,confirmDelivery:e.rr,icon:e.icon,image:e.image,topic:e.tag,badgeIcon:e.badge,actionButtons:this.toOSNotificationButtons(e.buttons)},timestamp:e.timestamp}}static toOSNotificationButtons(e){return e?.map(t=>({actionId:t.action,text:t.title,icon:t.icon,launchURL:t.url}))}}class Pt{static toDatabase(e,t){return{appId:e,notificationId:t.notification.notificationId,timestamp:t.timestamp}}static fromDatabase(e){return{appId:e.appId,notificationId:e.notificationId,timestamp:e.timestamp}}}class xt{static toDatabase(e,t,i){return{appId:e,notificationId:t.notificationId,timestamp:i}}static fromDatabase(e){return{appId:e.appId,notificationId:e.notificationId,timestamp:e.timestamp}}}var Nt=(s=>(s[s.SET=0]="SET",s))(Nt||{});const ii="ONE_SIGNAL_SDK_DB",Ve="Outcomes.NotificationClicked",Le="Outcomes.NotificationReceived",Ne="NotificationOpened",et="Sessions";class l{constructor(e){this.databaseName=e,this.emitter=new Qe,this.database=new Zt(this.databaseName)}emitter;database;static databaseInstanceName;static databaseInstance;static EVENTS=Nt;static resetInstance(){l.databaseInstance=null}static get singletonInstance(){return l.databaseInstanceName||(l.databaseInstanceName=ii),l.databaseInstance||(l.databaseInstance=new l(l.databaseInstanceName)),l.databaseInstance}static applyDbResultFilter(e,t,i){switch(e){case"Options":return i&&t?i.value:i&&!t?i:null;case"Ids":return i&&t?i.id:i&&!t?i:null;default:return i||null}}async get(e,t){const i=await this.database.get(e,t);return l.applyDbResultFilter(e,t,i)}async getAll(e){return await this.database.getAll(e)}async put(e,t){await new Promise(i=>{this.database.put(e,t).then(()=>i())}),this.emitter.emit(l.EVENTS.SET,t)}remove(e,t){return this.database.remove(e,t)}async getAppConfig(){const e={},t=await this.get("Ids","appId");return e.appId=t,e.vapidPublicKey=await this.get("Options","vapidPublicKey"),e}async setAppConfig(e){e.appId&&await this.put("Ids",{type:"appId",id:e.appId}),e.vapidPublicKey&&await this.put("Options",{key:"vapidPublicKey",value:e.vapidPublicKey})}async getAppState(){const e=new ei;return e.defaultNotificationUrl=await this.get("Options","defaultUrl"),e.defaultNotificationTitle=await this.get("Options","defaultTitle"),e.lastKnownPushEnabled=await this.get("Options","isPushEnabled"),e.pendingNotificationClickEvents=await this.getAllPendingNotificationClickEvents(),e.lastKnownPushId=await this.get("Options","lastPushId"),e.lastKnownPushToken=await this.get("Options","lastPushToken"),e.lastKnownOptedIn=await this.get("Options","lastOptedIn"),e}async setIsPushEnabled(e){await this.put("Options",{key:"isPushEnabled",value:e})}async setAppState(e){if(e.defaultNotificationUrl&&await this.put("Options",{key:"defaultUrl",value:e.defaultNotificationUrl}),(e.defaultNotificationTitle||e.defaultNotificationTitle==="")&&await this.put("Options",{key:"defaultTitle",value:e.defaultNotificationTitle}),e.lastKnownPushEnabled!=null&&await this.setIsPushEnabled(e.lastKnownPushEnabled),e.lastKnownPushId!=null&&await this.put("Options",{key:"lastPushId",value:e.lastKnownPushId}),e.lastKnownPushToken!=null&&await this.put("Options",{key:"lastPushToken",value:e.lastKnownPushToken}),e.lastKnownOptedIn!=null&&await this.put("Options",{key:"lastOptedIn",value:e.lastKnownOptedIn}),e.pendingNotificationClickEvents){const t=Object.keys(e.pendingNotificationClickEvents);for(const i of t){const n=e.pendingNotificationClickEvents[i];n?await this.put(Ne,{url:i,data:n.data,timestamp:n.timestamp}):n===null&&await this.remove(Ne,i)}}}async getUserState(){const e=new ti;return e.previousOneSignalId="",e.previousExternalId="",e.previousOneSignalId=await this.get("Options","previousOneSignalId"),e.previousExternalId=await this.get("Options","previousExternalId"),e}async setUserState(e){await this.put("Options",{key:"previousOneSignalId",value:e.previousOneSignalId}),await this.put("Options",{key:"previousExternalId",value:e.previousExternalId})}async getSubscription(){const e=new Xe;e.deviceId=await this.get("Ids","userId"),e.subscriptionToken=await this.get("Ids","registrationId");const t=await this.get("Options","optedOut"),i=await this.get("Options","subscription"),n=await this.get("Options","subscriptionCreatedAt"),a=await this.get("Options","subscriptionExpirationTime");return t!=null?e.optedOut=t:i==null?e.optedOut=!1:e.optedOut=!i,e.createdAt=n,e.expirationTime=a,e}async setDeviceId(e){await this.put("Ids",{type:"userId",id:e})}async setSubscription(e){e.deviceId&&await this.setDeviceId(e.deviceId),typeof e.subscriptionToken<"u"&&await this.put("Ids",{type:"registrationId",id:e.subscriptionToken}),e.optedOut!=null&&await this.put("Options",{key:"optedOut",value:e.optedOut}),e.createdAt!=null&&await this.put("Options",{key:"subscriptionCreatedAt",value:e.createdAt}),e.expirationTime!=null?await this.put("Options",{key:"subscriptionExpirationTime",value:e.expirationTime}):await this.remove("Options","subscriptionExpirationTime")}async setJWTToken(e){await this.put("Ids",{type:"jwtToken",id:e})}async getJWTToken(){return await this.get("Ids","jwtToken")}async setProvideUserConsent(e){await this.put("Options",{key:"userConsent",value:e})}async getConsentGiven(){return await this.get("Options","userConsent")}async getSession(e){return await this.get(et,e)}async setSession(e){await this.put(et,e)}async removeSession(e){await this.remove(et,e)}async getLastNotificationClickedForOutcomes(e){let t=[];try{t=await this.getAllNotificationClickedForOutcomes()}catch(n){g.error("Database.getLastNotificationClickedForOutcomes",n)}const i=n=>n.appId===e;return t.find(i)||null}async getAllNotificationClickedForOutcomes(){return(await this.getAll(Ve)).map(t=>Pt.fromDatabase(t))}async putNotificationClickedForOutcomes(e,t){await this.put(Ve,Pt.toDatabase(e,t))}async putNotificationClickedEventPendingUrlOpening(e){await this.put(Ne,kt.toDatabase(e))}async getAllPendingNotificationClickEvents(){const e={},t=await this.getAll(Ne);for(const i of t){const n=kt.fromDatabase(i),a=n.result.url;a&&(e[a]=n)}return e}async removeAllNotificationClickedForOutcomes(){await this.remove(Ve)}async getAllNotificationReceivedForOutcomes(){return(await this.getAll(Le)).map(t=>xt.fromDatabase(t))}async putNotificationReceivedForOutcomes(e,t){await this.put(Le,xt.toDatabase(e,t,new Date().getTime()))}async resetSentUniqueOutcomes(){const t=(await this.getAll("SentUniqueOutcome")).map(i=>(i.sentDuringSession=null,l.put("SentUniqueOutcome",i)));await Promise.all(t)}static async rebuild(){return Promise.all([l.singletonInstance.remove("Ids"),l.singletonInstance.remove(Ne),l.singletonInstance.remove("Options"),l.singletonInstance.remove(Le),l.singletonInstance.remove(Ve),l.singletonInstance.remove("SentUniqueOutcome")])}static async on(...e){return l.singletonInstance.emitter.on.apply(l.singletonInstance.emitter,e)}static async setIsPushEnabled(e){return l.singletonInstance.setIsPushEnabled(e)}static async getCurrentSession(){return await l.singletonInstance.getSession(Ze)}static async upsertSession(e){await l.singletonInstance.setSession(e)}static async cleanupCurrentSession(){await l.singletonInstance.removeSession(Ze)}static async setSubscription(e){return await l.singletonInstance.setSubscription(e)}static async getSubscription(){return await l.singletonInstance.getSubscription()}static async setJWTToken(e){return await l.singletonInstance.setJWTToken(e)}static async getJWTToken(){return await l.singletonInstance.getJWTToken()}static async setConsentGiven(e){return await l.singletonInstance.setProvideUserConsent(e)}static async getConsentGiven(){return await l.singletonInstance.getConsentGiven()}static async setAppState(e){return await l.singletonInstance.setAppState(e)}static async getAppState(){return await l.singletonInstance.getAppState()}static async setUserState(e){return await l.singletonInstance.setUserState(e)}static async getUserState(){return await l.singletonInstance.getUserState()}static async setAppConfig(e){return await l.singletonInstance.setAppConfig(e)}static async getAppConfig(){return await l.singletonInstance.getAppConfig()}static async getLastNotificationClickedForOutcomes(e){return await l.singletonInstance.getLastNotificationClickedForOutcomes(e)}static async removeAllNotificationClickedForOutcomes(){return await l.singletonInstance.removeAllNotificationClickedForOutcomes()}static async getAllNotificationReceivedForOutcomes(){return await l.singletonInstance.getAllNotificationReceivedForOutcomes()}static async putNotificationReceivedForOutcomes(e,t){return await l.singletonInstance.putNotificationReceivedForOutcomes(e,t)}static async getAllNotificationClickedForOutcomes(){return await l.singletonInstance.getAllNotificationClickedForOutcomes()}static async putNotificationClickedForOutcomes(e,t){return await l.singletonInstance.putNotificationClickedForOutcomes(e,t)}static async putNotificationClickedEventPendingUrlOpening(e){return await l.singletonInstance.putNotificationClickedEventPendingUrlOpening(e)}static async resetSentUniqueOutcomes(){return await l.singletonInstance.resetSentUniqueOutcomes()}static async setDeviceId(e){await l.singletonInstance.setDeviceId(e)}static async remove(e,t){return await l.singletonInstance.remove(e,t)}static async put(e,t){return await l.singletonInstance.put(e,t)}static async get(e,t){return await l.singletonInstance.get(e,t)}static async getAll(e){return await l.singletonInstance.getAll(e)}}const ni=["notifyButtonHovering","notifyButtonHover","notifyButtonButtonClick","notifyButtonLauncherClick","animatedElementHiding","animatedElementHidden","animatedElementShowing","animatedElementShown","activeAnimatedElementActivating","activeAnimatedElementActive","activeAnimatedElementInactivating","activeAnimatedElementInactive"];class q{static async trigger(e,t,i){if(!b.contains(ni,e)){const n=t,a=b.capitalize(k.getWindowEnv().toString());n||n===!1?g.debug(`(${a}) Â» ${e}:`,n):g.debug(`(${a}) Â» ${e}`)}if(O.isBrowser()){if(e===OneSignal.EVENTS.SDK_INITIALIZED){if(OneSignal.initialized)return;OneSignal.initialized=!0}i?await i.emit(e,t):await OneSignal.emitter.emit(e,t)}}}class ne{static executing=!1;static async triggerNotificationPermissionChanged(e=!1){if(!ne.executing){ne.executing=!0;try{await ne.privateTriggerNotificationPermissionChanged(e)}finally{ne.executing=!1}}}static async privateTriggerNotificationPermissionChanged(e){const t=await OneSignal.context.permissionManager.getPermissionStatus(),i=await l.get("Options","notificationPermission");(t!==i||e)&&(await l.put("Options",{key:"notificationPermission",value:t}),q.trigger(OneSignal.EVENTS.NOTIFICATION_PERMISSION_CHANGED_AS_STRING,t),this.triggerBooleanPermissionChangeEvent(i,t,e))}static triggerBooleanPermissionChangeEvent(e,t,i){const n=t==="granted";(n!==(e==="granted")||i)&&q.trigger(OneSignal.EVENTS.NOTIFICATION_PERMISSION_CHANGED_AS_BOOLEAN,n)}}async function Te(){return new Promise(s=>{OneSignal.initialized?s():OneSignal.emitter.once(OneSignal.EVENTS.SDK_INITIALIZED,s)})}function si(s,...e){if(s)return s.apply(null,e)}function v(s,...e){return z.logMethodCall(s,...e)}function ai(s){return!!s&&!!s.match(/^([^\x00-\x20\x22\x28\x29\x2c\x2e\x3a-\x3c\x3e\x40\x5b-\x5d\x7f-\xff]+|\x22([^\x0d\x22\x5c\x80-\xff]|\x5c[\x00-\x7f])*\x22)(\x2e([^\x00-\x20\x22\x28\x29\x2c\x2e\x3a-\x3c\x3e\x40\x5b-\x5d\x7f-\xff]+|\x22([^\x0d\x22\x5c\x80-\xff]|\x5c[\x00-\x7f])*\x22))*\x40([^\x00-\x20\x22\x28\x29\x2c\x2e\x3a-\x3c\x3e\x40\x5b-\x5d\x7f-\xff]+|\x5b([^\x0d\x5b-\x5d\x80-\xff]|\x5c[\x00-\x7f])*\x5d)(\x2e([^\x00-\x20\x22\x28\x29\x2c\x2e\x3a-\x3c\x3e\x40\x5b-\x5d\x7f-\xff]+|\x5b([^\x0d\x5b-\x5d\x80-\xff]|\x5c[\x00-\x7f])*\x5d))*$/)}function $(s,e){if(typeof s=="string"){const t=document.querySelector(s);if(t===null)throw new Error(`Cannot find element with selector "${s}"`);t.classList.add(e)}else if(typeof s=="object")s.classList.add(e);else throw new Error(`${s} must be a CSS selector string or DOM Element object.`)}function tt(s){return z.isValidUuid(s)}function oi(s){return s?V().name=="safari"&&s.safari?s.safari:V().name==="firefox"&&s.firefox?s.firefox:s.chrome||s.firefox||s.safari||"default-icon":"default-icon"}function it(s){return JSON.parse(JSON.stringify(s))}class ri{config;constructor(e){this.config=e}async initialize(){if(!this.config?.enabled||!await this.loadSdkStyles())return;g.info("OneSignal: initializing customlink");const e=await OneSignal.context.subscriptionManager.isPushNotificationsEnabled();if(!this.config?.unsubscribeEnabled&&e){this.hideCustomLinkContainers();return}for(let t=0;t<this.customlinkContainerElements.length;t++)await this.injectMarkup(this.customlinkContainerElements[t])}async injectMarkup(e){e.innerHTML="",await this.mountExplanationNode(e),await this.mountSubscriptionNode(e)}async mountExplanationNode(e){if(!this.config?.text){g.error("CustomLink: required property 'text' is missing in the config");return}if(this.config.text.explanation){const t=document.createElement("p");t.textContent=this.config.text.explanation,$(t,K.resetClass),$(t,K.explanationClass),this.config.size&&$(t,this.config.size),await OneSignal.context.subscriptionManager.isPushNotificationsEnabled()?$(t,K.state.subscribed):$(t,K.state.unsubscribed),e.appendChild(t)}}async mountSubscriptionNode(e){if(!this.config?.text){g.error("CustomLink: required property 'text' is missing in the config");return}if(this.config.text.subscribe){const t=document.createElement("button");$(t,K.resetClass),$(t,K.subscribeClass),this.config.size&&$(t,this.config.size),this.config.style&&$(t,this.config.style),await OneSignal.context.subscriptionManager.isPushNotificationsEnabled()?$(t,K.state.subscribed):$(t,K.state.unsubscribed),this.setCustomColors(t),await this.setTextFromPushStatus(t),t.addEventListener("click",async()=>{g.info("CustomLink: subscribe clicked"),await this.handleClick(t)}),t.setAttribute("type","button"),e.appendChild(t)}}async loadSdkStyles(){return await OneSignal.context.dynamicResourceLoader.loadSdkStylesheet()!==Ot.Loaded?(g.debug("Not initializing custom link button because styles failed to load."),!1):!0}hideElement(e){$(e,K.hide)}hideCustomLinkContainers(){this.customlinkContainerElements.forEach(e=>{this.hideElement(e)})}async handleClick(e){if(OneSignal.User.PushSubscription.optedIn)await OneSignal.User.PushSubscription.optOut(),await this.setTextFromPushStatus(e);else{await OneSignal.User.PushSubscription.optIn(),this.config?.unsubscribeEnabled||this.hideCustomLinkContainers();return}}async setTextFromPushStatus(e){this.config?.text?.subscribe&&(await OneSignal.context.subscriptionManager.isPushNotificationsEnabled()||(e.textContent=this.config.text.subscribe)),this.config?.text?.unsubscribe&&await OneSignal.context.subscriptionManager.isPushNotificationsEnabled()&&(e.textContent=this.config.text.unsubscribe)}setCustomColors(e){!this.config?.color||!this.config.color.text||(this.config?.style==="button"&&this.config?.color.button?(e.style.backgroundColor=this.config?.color.button,e.style.color=this.config?.color.text):this.config?.style==="link"&&(e.style.color=this.config?.color.text))}get customlinkContainerElements(){const e=document.querySelectorAll(Qt.containerSelector);return Array.prototype.slice.call(e)}}class U{static store={};static LIMIT=2;static put(e,t){return U.store[e]===void 0&&(U.store[e]=[null,null]),U.store[e].push(t),U.store[e].length==U.LIMIT+1&&U.store[e].shift(),U.store[e]}static get(e){return U.store[e]===void 0&&(U.store[e]=[null,null]),U.store[e]}static getFirst(e){return U.get(e)[0]}static getLast(e){return U.get(e)[1]}static remove(e){delete U.store[e]}static isEmpty(e){const t=U.get(e);return t[0]===null&&t[1]===null}}class Tt{static decodeHtmlEntities(e){return typeof DOMParser>"u"?e:new DOMParser().parseFromString(e,"text/html").documentElement.textContent||""}}var Y=(s=>(s.Native="native",s.Push="push",s.Category="category",s.Sms="sms",s.Email="email",s.SmsAndEmail="smsAndEmail",s))(Y||{});class me{static isCategorySlidedownConfigured(e){if(!e)return!1;const t=me.getFirstSlidedownPromptOptionsWithType(e,Y.Category);return t?!!t.categories&&t.categories.length>0:!1}static isCategorySlidedownConfiguredVersion1(e){return(e?.categories?.tags?.length||0)>0}static getFirstSlidedownPromptOptionsWithType(e,t){return e?e.filter(i=>i.type===t)[0]:void 0}static isSlidedownAutoPromptConfigured(e){if(!e)return!1;for(let t=0;t<e.length;t++)if(e[t].autoPrompt)return!0;return!1}static isSlidedownPushDependent(e){return e===Y.Push||e===Y.Category}}var Et=(s=>(s.HttpsPermissionRequest="HTTPS permission request",s.SlidedownPermissionMessage="slidedown permission message",s.SubscriptionBell="subscription bell",s))(Et||{}),le=(s=>(s[s.MissingAppId=0]="MissingAppId",s[s.RedundantPermissionMessage=1]="RedundantPermissionMessage",s[s.PushPermissionAlreadyGranted=2]="PushPermissionAlreadyGranted",s[s.UnsupportedEnvironment=3]="UnsupportedEnvironment",s[s.MissingDomElement=4]="MissingDomElement",s[s.ServiceWorkerNotActivated=5]="ServiceWorkerNotActivated",s))(le||{});class ue extends R{description;reason;constructor(e,t){let i;switch(e){case 0:i="Missing required app ID.";break;case 1:{let n="";t&&t.permissionPromptType&&(n=`(${Et[t.permissionPromptType]})`),i=`Another permission message ${n} is being displayed.`;break}case 2:i="Push permission has already been granted.";break;case 3:i="The current environment does not support this operation.";break;case 5:i="The service worker must be activated first.";break}super(i),this.description=le[e],this.reason=e,Object.setPrototypeOf(this,ue.prototype)}}var nt=(s=>(s[s.Unknown=0]="Unknown",s[s.NoDeviceId=1]="NoDeviceId",s[s.NoEmailSet=2]="NoEmailSet",s[s.NoSMSSet=3]="NoSMSSet",s[s.OptedOut=4]="OptedOut",s))(nt||{});class st extends R{reason;constructor(e){let t;switch(e){case 1:t="This operation can only be performed after the user is subscribed.";break;case 2:t="No email is currently set.";break;case 3:t="No sms is currently set.";break;case 4:t="The user has manually opted out of receiving of notifications. This operation can only be performed after the user is fully resubscribed.";break}super(t),this.reason=nt[e],Object.setPrototypeOf(this,st.prototype)}}class at{static isValidUrl(e,t){if(t&&t.allowNull&&e===null)return!0;if(t&&t.allowEmpty&&e==null)return!0;try{const i=new URL(e);return t&&t.requireHttps?i.protocol==="https:":!0}catch{return!1}}static isValidBoolean(e,t){return t&&t.allowNull&&e===null?!0:e===!0||e===!1}static isValidArray(e,t){return t&&t.allowNull&&e===null||t&&t.allowEmpty&&e==null?!0:e instanceof Array}}class te{static async showLocalNotification(e,t,i,n,a,o){if(v("MainHelper:showLocalNotification: ",e,t,i,n,a,o),!(await l.getAppConfig()).appId)throw new ue(le.MissingAppId);if(!OneSignal.Notifications.permission)throw new st(nt.NoDeviceId);if(!at.isValidUrl(i))throw new S("url",w.Malformed);if(!at.isValidUrl(n,{allowEmpty:!0,requireHttps:!0}))throw new S("icon",w.Malformed);if(!n){const d=await te.getNotificationIcons();n=oi(d)}const p=d=>{const m=[];for(let y=0;y<d.length;y++){const T=d[y];m.push({action:T.id,title:T.text,icon:T.icon,url:T.url})}return m},u={data:a,launchURL:i,buttons:o?p(o):void 0};OneSignal.context.serviceWorkerManager.getRegistration().then(async d=>{if(!d){g.error("Service worker registration not available.");return}const m={body:t,data:u,icon:n,actions:o?p(o):[]};d.showNotification(e,m)})}static async checkAndTriggerNotificationPermissionChanged(){const e=await l.get("Options","notificationPermission"),t=await OneSignal.context.permissionManager.getPermissionStatus();e!==t&&(await ne.triggerNotificationPermissionChanged(),await l.put("Options",{key:"notificationPermission",value:t}))}static async getNotificationIcons(){const e=await te.getAppId();if(!e)throw new ue(le.MissingAppId);const t=`${k.getOneSignalApiUrl().toString()}/apps/${e}/icon`,n=await(await fetch(t)).json();if(n.errors)throw g.error(`API call ${t}`,"failed with:",n.errors),new Error("Failed to get notification icons.");return n}static getSlidedownOptions(e){return b.getValueOrDefault(e.slidedown,{prompts:[]})}static getFullscreenPermissionMessageOptions(e){return e?e.fullscreen?{autoAcceptTitle:e.fullscreen.autoAcceptTitle,actionMessage:e.fullscreen.actionMessage,exampleNotificationTitleDesktop:e.fullscreen.title,exampleNotificationTitleMobile:e.fullscreen.title,exampleNotificationMessageDesktop:e.fullscreen.message,exampleNotificationMessageMobile:e.fullscreen.message,exampleNotificationCaption:e.fullscreen.caption,acceptButton:e.fullscreen.acceptButton,cancelButton:e.fullscreen.cancelButton}:e:null}static getPromptOptionsQueryString(){const e=te.getFullscreenPermissionMessageOptions(OneSignal.config.userConfig.promptOptions);let t="";if(e){const i=te.getPromptOptionsPostHash();for(const n of Object.keys(i)){const a=i[n];t+="&"+n+"="+a}}return t}static getPromptOptionsPostHash(){const e=te.getFullscreenPermissionMessageOptions(OneSignal.config.userConfig.promptOptions),t={};if(e){const i={exampleNotificationTitleDesktop:"exampleNotificationTitle",exampleNotificationMessageDesktop:"exampleNotificationMessage",exampleNotificationTitleMobile:"exampleNotificationTitle",exampleNotificationMessageMobile:"exampleNotificationMessage"};for(const a of Object.keys(i)){const o=i[a];e[a]&&(e[o]=e[a])}const n=["autoAcceptTitle","siteName","autoAcceptTitle","subscribeText","showGraphic","actionMessage","exampleNotificationTitle","exampleNotificationMessage","exampleNotificationCaption","acceptButton","cancelButton","timeout"];for(let a=0;a<n.length;a++){const o=n[a],r=e[o],p=encodeURIComponent(r);(r||r===!1||r==="")&&(t[o]=p)}}return t}static async getAppId(){return OneSignal.config.appId?Promise.resolve(OneSignal.config.appId):await l.get("Ids","appId")}static async getDeviceId(){return(await OneSignal.database.getSubscription()).deviceId||void 0}static async getCurrentPushToken(){if(O.useSafariLegacyPush())return window.safari?.pushNotification?.permission(OneSignal.config.safariWebId).deviceToken?.toLowerCase()||void 0;const e=await OneSignal.context.serviceWorkerManager.getRegistration();return e?(await e.pushManager.getSubscription())?.endpoint:void 0}}class ci{subscribers=new Set;subscribe(e){return this.subscribers.add(e),()=>this.subscribers.delete(e)}broadcast(e){this.subscribers.forEach(t=>{t(e)})}}var ot=(s=>(s.Add="add",s.Remove="remove",s.Update="update",s.Hydrate="hydrate",s))(ot||{});class li{constructor(e,t){this.modelId=e,this.payload=t}type=ot.Update}class ui{constructor(e,t){this.modelId=e,this.payload=t}type=ot.Hydrate}class di{constructor(e,t,i,n){this.model=e,this.property=t,this.oldValue=i,this.newValue=n}}class we extends ci{constructor(e,t,i){super(),this.modelName=e,this.modelId=i??Math.random().toString(36).substring(2),this.modelName=e,this.data=t,this.onesignalId=void 0,this.externalId=void 0,this.awaitOneSignalIdAvailable=new Promise(n=>{this.onesignalIdAvailableCallback=n})}data;modelId;onesignalId;awaitOneSignalIdAvailable;onesignalIdAvailableCallback;externalId;applyToRecordId;setOneSignalId(e){v("setOneSignalId",{onesignalId:e}),this.onesignalId=e,e&&this.onesignalIdAvailableCallback?.(e)}setExternalId(e){v("setExternalId",{externalId:e}),this.externalId=e}setApplyToRecordId(e){v("setapplyToRecordId",{applyToRecordId:e}),this.applyToRecordId=e}set(e,t,i=!0){v("set",{property:e,newValue:t});let n;if(this.data&&(n=this.data[e],this.data[e]=t),i){const a=new li(this.modelId,new di(this,e,n,t));this.broadcast(a)}}hydrate(e){v("hydrate",{data:e}),this.data=e,this.broadcast(new ui(this.modelId,this))}encode(){const e=this.modelId,t=this.modelName,i=this.onesignalId,n=this.externalId;return{modelId:e,modelName:t,onesignalId:i,externalId:n,...this.data}}static decode(e){v("decode",{encodedModel:e});const{modelId:t,modelName:i,onesignalId:n,externalId:a,...o}=e,r=new we(i,o,t);return r.setOneSignalId(n),r.setExternalId(a),r}}var J=(s=>(s.ChromePush="ChromePush",s.SafariPush="SafariPush",s.SafariLegacyPush="SafariLegacyPush",s.FirefoxPush="FirefoxPush",s.Email="Email",s.SMS="SMS",s))(J||{}),rt=(s=>(s[s.MissingAppId=0]="MissingAppId",s[s.RetryLimitReached=1]="RetryLimitReached",s))(rt||{});class Fe extends R{reason;constructor(e){let t;switch(e){case 0:t="The API call is missing an app ID.";break;case 1:t="The API call has reached the retry limit.";break}super(t),Object.setPrototypeOf(this,Fe.prototype)}}function ct(s){return new Promise(e=>setTimeout(e,s))}const gi={5:1e4,4:2e4,3:3e4,2:3e4,1:3e4};class I{static get(e,t,i){return I.call("GET",e,t,i)}static post(e,t,i){return I.call("POST",e,t,i)}static put(e,t,i){return I.call("PUT",e,t,i)}static delete(e,t,i){return I.call("DELETE",e,t,i)}static patch(e,t,i){return I.call("PATCH",e,t,i)}static call(e,t,i,n){if(!this.requestHasAppId(t,i))return Promise.reject(new Fe(rt.MissingAppId));const a=new Headers;if(a.append("Origin",k.getOrigin()),a.append("SDK-Version",`onesignal/web/${O.version()}`),a.append("Content-Type","application/json;charset=UTF-8"),n)for(const p of Object.keys(n))a.append(p,n[p]);const o={method:e||"NO_METHOD_SPECIFIED",headers:a,cache:"no-cache"};i&&(o.body=JSON.stringify(i));const r=`${k.getOneSignalApiUrl(void 0,t).toString()}/${t}`;return I.executeFetch(r,o)}static async executeFetch(e,t,i=5){if(i===0)return Promise.reject(new Fe(rt.RetryLimitReached));try{const n=await fetch(e,t),{status:a}=n;return{result:await n.json(),status:a}}catch(n){if(n.name==="TypeError")return await ct(gi[i]),g.error(`OneSignal: Network timed out while calling ${e}. Retrying...`),I.executeFetch(e,t,i-1);throw new R(`OneSignalApiBase: failed to execute HTTP call: ${n}`)}}static requestHasAppId(e,t){if(e.startsWith("apps/")){const i=e.split("/");return tt(i[1])}if(e.startsWith("sync/")){const i=e.split("/");return tt(i[1])}return t&&typeof t.app_id=="string"?tt(t.app_id):!1}}function pi(s){const e="=".repeat((4-s.length%4)%4),t=(s+e).replace(/-/g,"+").replace(/_/g,"/"),i=atob(t),n=new Uint8Array(i.length);for(let a=0;a<i.length;++a)n[a]=i.charCodeAt(a);return n}function At(s){return encodeURIComponent(s).replace(/[!'()*]/g,e=>`%${e.charCodeAt(0).toString(16).toUpperCase()}`)}var se=(s=>(s[s.InvalidAppId=0]="InvalidAppId",s[s.AppNotConfiguredForWebPush=1]="AppNotConfiguredForWebPush",s[s.WrongSiteUrl=2]="WrongSiteUrl",s[s.MultipleInitialization=3]="MultipleInitialization",s[s.MissingSafariWebId=4]="MissingSafariWebId",s[s.Unknown=5]="Unknown",s))(se||{});class ae extends R{reason;constructor(e,t){let i;switch(e){case 0:i="OneSignal: This app ID does not match any existing app. Double check your app ID.";break;case 1:i="OneSignal: This app ID does not have any web platforms enabled. Double check your app ID, or see step 1 on our setup guide (https://tinyurl.com/2x5jzk83).";break;case 2:t&&t.siteUrl?i=`OneSignal: This web push config can only be used on ${new URL(t.siteUrl).origin}. Your current origin is ${location.origin}.`:i="OneSignal: This web push config can not be used on the current site.";break;case 3:i="OneSignal: The OneSignal web SDK can only be initialized once. Extra initializations are ignored. Please remove calls initializing the SDK more than once.";break;case 4:i="OneSignal: Safari browser support on Mac OS X requires the Safari web platform to be enabled. Please see the Safari Support steps in our web setup guide.";break;case 5:i="OneSignal: An unknown initialization error occurred.";break}super(i),this.reason=se[e],Object.setPrototypeOf(this,ae.prototype)}}class lt{static async createUser(e,t){const{appId:i,subscriptionId:n}=e,a=n?{"OneSignal-Subscription-Id":n}:void 0;let o={};return a&&(o={...o,...a}),e.jwtHeader&&(o={...o,...e.jwtHeader}),t.refresh_device_metadata=!0,I.post(`apps/${i}/users`,t,o)}static async getUser(e,t){const{appId:i}=e;return I.get(`apps/${i}/users/by/${t.label}/${t.id}`,e.jwtHeader)}static async updateUser(e,t,i){const{appId:n,subscriptionId:a}=e;if(!z.isValidUuid(n))throw new ae(se.InvalidAppId);const o=a?{"OneSignal-Subscription-Id":a}:void 0;let r={};o&&(r={...r,...o}),e.jwtHeader&&(r={...r,...e.jwtHeader});const p={label:At(t.label),id:At(t.id)};return I.patch(`apps/${n}/users/by/${p.label}/${p.id}`,i,r)}static async deleteUser(e,t){const{appId:i}=e;return I.delete(`apps/${i}/users/by/${t.label}/${t.id}`,e.jwtHeader)}static async addAlias(e,t,i){const{appId:n}=e;return I.patch(`apps/${n}/users/by/${t.label}/${t.id}/identity`,{identity:i},e.jwtHeader)}static async getUserIdentity(e,t){const{appId:i}=e;return I.get(`apps/${i}/users/by/${t.label}/${t.id}/identity`,e.jwtHeader)}static async deleteAlias(e,t,i){const{appId:n}=e;return I.delete(`apps/${n}/users/by/${t.label}/${t.id}/identity/${i}`,e.jwtHeader)}static async createSubscription(e,t,i){const{appId:n}=e;return I.post(`apps/${n}/users/by/${t.label}/${t.id}/subscriptions`,i,e.jwtHeader)}static async updateSubscription(e,t,i){const{appId:n}=e;return I.patch(`apps/${n}/subscriptions/${t}`,{subscription:i})}static async deleteSubscription(e,t){const{appId:i}=e;return I.delete(`apps/${i}/subscriptions/${t}`)}static async fetchAliasesForSubscription(e,t){const{appId:i}=e;return I.get(`apps/${i}/subscriptions/${t}/identity`)}static async identifyUserForSubscription(e,t,i){const{appId:n}=e;return I.patch(`apps/${n}/users/by/subscriptions/${t}/identity`,{identity:i},e.jwtHeader)}static async transferSubscription(e,t,i,n){const{appId:a}=e;return I.patch(`apps/${a}/subscriptions/${t}/owner`,{identity:{...i},retain_previous_owner:n},e.jwtHeader)}}function de(s){return s?.type!==void 0&&s?.id!==void 0}class L{static async initializeUser(e){v("initializeUser",{isTemporary:e});const t=OneSignal.coreDirector.getIdentityModel(),i=OneSignal.coreDirector.getPropertiesModel();if(!!t&&!!i){g.debug("User already exists, skipping initialization.");return}L.createUserPropertiesModel(),await L.createAnonymousUser(e)}static resetUserMetaProperties(){const e=A.createOrGetInstance();e.hasOneSignalId=!1,e.awaitOneSignalIdAvailable=void 0,e.isCreatingUser=!1}static async createAnonymousUser(e){let t;if(e)t={};else{const n=await L.createUserOnServer();if(n)t=n.identity,OneSignal.coreDirector.hydrateUser(n);else return}const i=new we(x.Identity,t);i.setOneSignalId(t.onesignal_id),OneSignal.coreDirector.add(x.Identity,i,!1),await this.copyOneSignalIdPromiseFromIdentityModel()}static createUserPropertiesModel(){const e={language:O.getLanguage(),timezone_id:Intl.DateTimeFormat().resolvedOptions().timeZone},t=new we(x.Properties,e);return OneSignal.coreDirector.add(x.Properties,t,!1),t}static async createUserOnServer(){const e=A.createOrGetInstance();if(!e.isCreatingUser){e.isCreatingUser=!0;try{const t=await te.getAppId(),i=await OneSignal.coreDirector.getPushSubscriptionModel();let n;de(i?.data)&&(n=i?.data.id);const a=await L.getAllUserData(),o=await lt.createUser({appId:t,subscriptionId:n},a);e.isCreatingUser=!1;const r=o.status,p=o.result;if(r>=200&&r<300){const u=a.identity?.onesignal_id;u&&OneSignal.coreDirector.getNewRecordsState().add(u);const d=a.subscriptions[0].token,m=p.subscriptions.find(y=>y.token===d);m&&de(m)&&OneSignal.coreDirector.getNewRecordsState().add(m.id)}return p}catch(t){g.error(t)}}}static async createAndHydrateUser(){const e=await L.createUserOnServer();e&&OneSignal.coreDirector.hydrateUser(e)}static async getAllUserData(){v("LoginManager.getAllUserData");const e=OneSignal.coreDirector.getIdentityModel(),t=OneSignal.coreDirector.getPropertiesModel(),i=await OneSignal.coreDirector.getAllSubscriptionsModels(),n={};return n.identity=e?.data,n.properties=t?.data,n.subscriptions=i?.map(a=>a.data),n}static async copyOneSignalIdPromiseFromIdentityModel(){const e=A.createOrGetInstance(),t=OneSignal.coreDirector.getIdentityModel();e.awaitOneSignalIdAvailable=t?.awaitOneSignalIdAvailable,e.awaitOneSignalIdAvailable?.then(i=>{e.hasOneSignalId=!0,e.onesignalId=i})}static async updateModelWithCurrentUserOneSignalId(e){const t=A.createOrGetInstance();await t.awaitOneSignalIdAvailable,e.setOneSignalId(t.onesignalId)}}class A{hasOneSignalId=!1;onesignalId;awaitOneSignalIdAvailable;isCreatingUser=!1;static singletonInstance=void 0;static createOrGetInstance(){return A.singletonInstance||(A.singletonInstance=new A,L.initializeUser(!0).then(()=>{L.copyOneSignalIdPromiseFromIdentityModel().catch(e=>{console.error(e)})}).catch(e=>{console.error(e)})),A.singletonInstance}addAlias(e,t){if(v("addAlias",{label:e,id:t}),typeof e!="string")throw new S("label",w.WrongType);if(typeof t!="string")throw new S("id",w.WrongType);if(!e)throw new S("label",w.Empty);if(!t)throw new S("id",w.Empty);this.addAliases({[e]:t})}addAliases(e){if(v("addAliases",{aliases:e}),!e||Object.keys(e).length===0)throw new S("aliases",w.Empty);Object.keys(e).forEach(async i=>{if(typeof i!="string")throw new S("label",w.WrongType)});const t=OneSignal.coreDirector.getIdentityModel();t?.setApplyToRecordId(t?.onesignalId),Object.keys(e).forEach(async i=>{t?.set(i,e[i])})}removeAlias(e){if(v("removeAlias",{label:e}),typeof e!="string")throw new S("label",w.WrongType);if(!e)throw new S("label",w.Empty);this.removeAliases([e])}removeAliases(e){if(v("removeAliases",{aliases:e}),!e||e.length===0)throw new S("aliases",w.Empty);const t=OneSignal.coreDirector.getIdentityModel();t?.setApplyToRecordId(t?.onesignalId),e.forEach(async i=>{t?.set(i,void 0)})}async addEmail(e){if(v("addEmail",{email:e}),typeof e!="string")throw new S("email",w.WrongType);if(!e)throw new S("email",w.Empty);if(!ai(e))throw new S("email",w.Malformed);const t={type:J.Email,token:e},i=new we(x.Subscriptions,t);if(A.singletonInstance?.isCreatingUser||A.singletonInstance?.hasOneSignalId){i.setOneSignalId(A.singletonInstance?.onesignalId);const a=OneSignal.coreDirector.getIdentityModel();a.data.external_id&&i.setExternalId(a.data.external_id),OneSignal.coreDirector.add(x.Subscriptions,i,!0)}else OneSignal.coreDirector.add(x.Subscriptions,i,!1),await L.createAndHydrateUser();L.updateModelWithCurrentUserOneSignalId(i).catch(a=>{throw a});const n=OneSignal.coreDirector.getIdentityModel();n.data.external_id&&i.setExternalId(n.data.external_id)}async addSms(e){if(v("addSms",{sms:e}),typeof e!="string")throw new S("sms",w.WrongType);if(!e)throw new S("sms",w.Empty);const t={type:J.SMS,token:e},i=new we(x.Subscriptions,t);if(A.singletonInstance?.isCreatingUser||A.singletonInstance?.hasOneSignalId){i.setOneSignalId(A.singletonInstance?.onesignalId);const a=OneSignal.coreDirector.getIdentityModel();a.data.external_id&&i.setExternalId(a.data.external_id),OneSignal.coreDirector.add(x.Subscriptions,i,!0)}else OneSignal.coreDirector.add(x.Subscriptions,i,!1),await L.createAndHydrateUser();L.updateModelWithCurrentUserOneSignalId(i).catch(a=>{throw a});const n=OneSignal.coreDirector.getIdentityModel();n.data.external_id&&i.setExternalId(n.data.external_id)}removeEmail(e){if(v("removeEmail",{email:e}),typeof e!="string")throw new S("email",w.WrongType);if(!e)throw new S("email",w.Empty);const t=OneSignal.coreDirector.getEmailSubscriptionModels();Object.keys(t).forEach(async n=>{t[n].data?.token===e&&OneSignal.coreDirector.remove(x.Subscriptions,n)})}removeSms(e){if(v("removeSms",{smsNumber:e}),typeof e!="string")throw new S("smsNumber",w.WrongType);if(!e)throw new S("smsNumber",w.Empty);const t=OneSignal.coreDirector.getSmsSubscriptionModels();Object.keys(t).forEach(async n=>{t[n].data?.token===e&&OneSignal.coreDirector.remove(x.Subscriptions,n)})}addTag(e,t){if(v("addTag",{key:e,value:t}),typeof e!="string")throw new S("key",w.WrongType);if(typeof t!="string")throw new S("value",w.WrongType);if(!e)throw new S("key",w.Empty);if(!t)throw new S("value",w.Empty,"Did you mean to call removeTag?");this.addTags({[e]:t})}addTags(e){if(v("addTags",{tags:e}),typeof e!="object")throw new S("tags",w.WrongType);if(!e)throw new S("tags",w.Empty);const t=OneSignal.coreDirector.getPropertiesModel();e={...t?.data?.tags,...e},t?.set("tags",e)}removeTag(e){if(v("removeTag",{tagKey:e}),typeof e!="string")throw new S("tagKey",w.WrongType);if(typeof e>"u")throw new S("tagKey",w.Empty);this.removeTags([e])}removeTags(e){if(v("removeTags",{tagKeys:e}),!e||e.length===0)throw new S("tagKeys",w.Empty);const t=OneSignal.coreDirector.getPropertiesModel(),i=JSON.parse(JSON.stringify(t?.data?.tags));i&&(e.forEach(n=>{i[n]=""}),t?.setApplyToRecordId(t?.onesignalId),t?.set("tags",i))}getTags(){return v("getTags"),OneSignal.coreDirector.getPropertiesModel()?.data?.tags}setLanguage(e){if(v("setLanguage",{language:e}),typeof e!="string")throw new S("language",w.WrongType);if(!e)throw new S("language",w.Empty);OneSignal.coreDirector.getPropertiesModel()?.set("language",e)}getLanguage(){return v("getLanguage"),OneSignal.coreDirector.getPropertiesModel()?.data?.language}}class Ct{}class Ut extends Ct{_id;_token;_optedIn;_permission;constructor(e,t,i){if(super(),!e||!t){g.warn(`PushSubscriptionNamespace: skipping initialization. One or more required params are falsy: initialize: ${e}, subscription: ${t}`);return}this._optedIn=!t.optedOut,this._permission=i,this._token=t.subscriptionToken,OneSignal.coreDirector.getPushSubscriptionModel().then(n=>{n&&de(n.data)&&(this._id=n.data.id)}).catch(n=>{g.error(n)}),OneSignal.emitter.on(OneSignal.EVENTS.SUBSCRIPTION_CHANGED,async n=>{this._id=n?.current.id,this._token=n?.current.token}),OneSignal.emitter.on(OneSignal.EVENTS.NOTIFICATION_PERMISSION_CHANGED_AS_STRING,async n=>{this._permission=n})}get id(){return this._id}get token(){return this._token}get optedIn(){return!!this._optedIn&&this._permission==="granted"}async optIn(){if(v("optIn"),await Te(),this._optedIn=!0,await OneSignal.context.permissionManager.getPermissionStatus()!=="granted"){await OneSignal.Notifications.requestPermission();return}await this._enable(!0)}async optOut(){v("optOut"),await Te(),this._optedIn=!1,await this._enable(!1)}addEventListener(e,t){OneSignal.emitter.on(e,t)}removeEventListener(e,t){OneSignal.emitter.off(e,t)}async _enable(e){await Te();const t=await l.getAppConfig(),i=await l.getSubscription();if(!t.appId)throw new ue(le.MissingAppId);if(!at.isValidBoolean(e))throw new S("enabled",w.Malformed);i.optedOut=!e,await l.setSubscription(i),_.onInternalSubscriptionSet(i.optedOut).catch(n=>{g.error(n)}),_.checkAndTriggerSubscriptionChanged().catch(n=>{g.error(n)})}}class Be extends Ct{_currentUser;PushSubscription=new Ut(!1);static emitter=new Qe;constructor(e,t,i){super(),e&&(this._currentUser=A.createOrGetInstance(),this.PushSubscription=new Ut(!0,t,i))}get onesignalId(){return this._currentUser?.onesignalId}get externalId(){return OneSignal.coreDirector.getIdentityModel()?.data?.external_id}addAlias(e,t){this._currentUser?.addAlias(e,t)}addAliases(e){this._currentUser?.addAliases(e)}removeAlias(e){this._currentUser?.removeAlias(e)}removeAliases(e){this._currentUser?.removeAliases(e)}addEmail(e){this._currentUser?.addEmail(e)}removeEmail(e){this._currentUser?.removeEmail(e)}addSms(e){this._currentUser?.addSms(e)}removeSms(e){this._currentUser?.removeSms(e)}addTag(e,t){this._currentUser?.addTag(e,t)}addTags(e){this._currentUser?.addTags(e)}removeTag(e){this._currentUser?.removeTag(e)}removeTags(e){this._currentUser?.removeTags(e)}getTags(){return this._currentUser?.getTags()||{}}setLanguage(e){this._currentUser?.setLanguage(e)}getLanguage(){return this._currentUser?.getLanguage()||""}addEventListener(e,t){Be.emitter.on(e,t)}removeEventListener(e,t){Be.emitter.off(e,t)}}class _{static onNotificationPermissionChange(){_.checkAndTriggerSubscriptionChanged()}static async onInternalSubscriptionSet(e){U.put("subscription.optedOut",e)}static async checkAndTriggerSubscriptionChanged(){z.logMethodCall("checkAndTriggerSubscriptionChanged");const e=OneSignal.context,t=await OneSignal.context.subscriptionManager.isPushNotificationsEnabled(),i=await OneSignal.context.subscriptionManager.isOptedIn(),n=await l.getAppState(),{lastKnownPushEnabled:a,lastKnownPushId:o,lastKnownPushToken:r,lastKnownOptedIn:p}=n,u=await te.getCurrentPushToken(),m=(await OneSignal.coreDirector.getPushSubscriptionModel())?.data?.id;if(!(a===null||t!==a||u!==r||m!==o))return;await e.subscriptionManager.updateNotificationTypes(),n.lastKnownPushEnabled=t,n.lastKnownPushToken=u,n.lastKnownPushId=m,n.lastKnownOptedIn=i,await l.setAppState(n);const T={previous:{id:o,token:r,optedIn:p??!0},current:{id:m,token:u,optedIn:i}};g.info("Push Subscription state changed: ",T),_.triggerSubscriptionChanged(T)}static async _onSubscriptionChanged(e){_.onSubscriptionChanged_showWelcomeNotification(e?.current?.optedIn,e?.current?.id),_.onSubscriptionChanged_sendCategorySlidedownTags(e?.current?.optedIn),_.onSubscriptionChanged_evaluateNotifyButtonDisplayPredicate(),_.onSubscriptionChanged_updateCustomLink()}static async onSubscriptionChanged_sendCategorySlidedownTags(e){if(e!==!0)return;const t=OneSignal.context.appConfig.userConfig.promptOptions?.slidedown?.prompts;me.isCategorySlidedownConfigured(t)&&await OneSignal.context.tagManager.sendTags()}static async onSubscriptionChanged_showWelcomeNotification(e,t){if(OneSignal.__doNotShowWelcomeNotification){g.debug("Not showing welcome notification because user has previously subscribed.");return}const i=OneSignal.config?.userConfig.welcomeNotification;if(i!==void 0&&i.disable===!0||e!==!0||!t)return;let a=i!==void 0&&i.title!==void 0&&i.title!==null?i.title:"",o=i!==void 0&&i.message!==void 0&&i.message!==null&&i.message.length>0?i.message:"Thanks for subscribing!";const r=new URL(location.href).origin+"?_osp=do_not_open",p=i&&i.url&&i.url.length>0?i.url:r;a=Tt.decodeHtmlEntities(a),o=Tt.decodeHtmlEntities(o),g.debug("Sending welcome notification."),te.showLocalNotification(a,o,p,void 0,{__isOneSignalWelcomeNotification:!0},void 0),q.trigger(OneSignal.EVENTS.WELCOME_NOTIFICATION_SENT,{title:a,message:o,url:p})}static async onSubscriptionChanged_evaluateNotifyButtonDisplayPredicate(){if(!OneSignal.config.userConfig.notifyButton)return;const e=OneSignal.config.userConfig.notifyButton.displayPredicate;e&&typeof e=="function"&&OneSignal.notifyButton&&(await e()!==!1?(g.debug("Showing notify button because display predicate returned true."),OneSignal.notifyButton.launcher.show()):(g.debug("Hiding notify button because display predicate returned false."),OneSignal.notifyButton.launcher.hide()))}static async onSubscriptionChanged_updateCustomLink(){OneSignal.config.userConfig.promptOptions&&new ri(OneSignal.config.userConfig.promptOptions.customlink).initialize()}static triggerSubscriptionChanged(e){q.trigger(OneSignal.EVENTS.SUBSCRIPTION_CHANGED,e)}static triggerUserChanged(e){q.trigger(OneSignal.EVENTS.SUBSCRIPTION_CHANGED,e,Be.emitter)}static triggerNotificationClick(e){const t={notification:e.notification,result:e.result};return q.trigger(OneSignal.EVENTS.NOTIFICATION_CLICKED,t)}static async fireStoredNotificationClicks(){await Te();const e=OneSignal.config.pageUrl||OneSignal.config.userConfig.pageUrl||document.URL;async function t(a){const o=await l.getAppState();o.pendingNotificationClickEvents[a.result.url]=null,await l.setAppState(o);const r=a.timestamp;r&&(Date.now()-r)/1e3/60>5||_.triggerNotificationClick(a)}const i=await l.getAppState();if(await l.get("Options","notificationClickHandlerMatch")==="origin"){for(const a of Object.keys(i.pendingNotificationClickEvents))if(new URL(a).origin===location.origin){const o=i.pendingNotificationClickEvents[a];await t(o)}}else{let a=i.pendingNotificationClickEvents[e];if(a)await t(a);else if(!a&&e.endsWith("/")){const o=e.substring(0,e.length-1);a=i.pendingNotificationClickEvents[o],a&&await t(a)}}}static async checkAndTriggerUserChanged(){z.logMethodCall("checkAndTriggerUserChanged");const e=await l.getUserState(),{previousOneSignalId:t,previousExternalId:i}=e,n=await OneSignal.coreDirector.getIdentityModel(),a=n?.onesignalId,o=n?.data?.external_id;if(!(a!==t||o!==i))return;e.previousOneSignalId=a,e.previousExternalId=o,await l.setUserState(e);const p={current:{onesignalId:a,externalId:o}};g.info("User state changed: ",p),_.triggerUserChanged(p)}}class h{static debug(...e){self.shouldLog&&console.debug(...e)}static trace(...e){self.shouldLog&&console.trace(...e)}static info(...e){self.shouldLog&&console.info(...e)}static warn(...e){self.shouldLog&&console.warn(...e)}static error(...e){self.shouldLog&&console.error(...e)}}function $e(s,e){const t=e*1e3;let i,n=()=>{};return{promise:new Promise((o,r)=>{let p=!1;i=self.setTimeout(async()=>{p=!0;try{await s(),o()}catch(u){h.error("Failed to execute callback",u),r()}},t),n=()=>{h.debug("Cancel called"),self.clearTimeout(i),p||o()}}),cancel:n}}var Q=(s=>(s[s.Direct=1]="Direct",s[s.Indirect=2]="Indirect",s[s.Unattributed=3]="Unattributed",s[s.NotSupported=4]="NotSupported",s))(Q||{});const fi="sendOutcome",hi="sendUniqueOutcome";class ut{outcomeName;config;appId;isUnique;constructor(e,t,i,n){this.outcomeName=i,this.config=t,this.appId=e,this.isUnique=n}async getAttribution(){return await ut.getAttribution(this.config)}async beforeOutcomeSend(){const e=this.isUnique?hi:fi;return v(e,this.outcomeName),this.config?this.outcomeName?(await Te(),await OneSignal.context.subscriptionManager.isPushNotificationsEnabled()?!0:(g.warn("Reporting outcomes is supported only for subscribed users."),!1)):(g.error("Outcome name is required"),!1):(g.debug("Outcomes feature not supported by main application yet."),!1)}async getAttributedNotifsByUniqueOutcomeName(){return(await l.getAll("SentUniqueOutcome")).filter(t=>t.outcomeName===this.outcomeName).reduce((t,i)=>{const n=i.notificationIds||[];return[...t,...n]},[])}async getNotifsToAttributeWithUniqueOutcome(e){const t=await this.getAttributedNotifsByUniqueOutcomeName();return e.filter(i=>t.indexOf(i)===-1)}shouldSendUnique(e,t){return e.type===Q.Unattributed?!0:t.length>0}async saveSentUniqueOutcome(e){const t=this.outcomeName,i=await l.get("SentUniqueOutcome",t),n=await l.getCurrentSession(),o=[...i?i.notificationIds:[],...e],r=n?n.startTimestamp:null;await l.put("SentUniqueOutcome",{outcomeName:t,notificationIds:o,sentDuringSession:r})}async wasSentDuringSession(){const e=await l.get("SentUniqueOutcome",this.outcomeName);if(!e)return!1;const t=await l.getCurrentSession(),i=t&&e.sentDuringSession===t.startTimestamp,n=!t&&!!e.sentDuringSession;return i||n}async send(e){const{type:t,notificationIds:i,weight:n}=e;switch(t){case Q.Direct:this.isUnique&&await this.saveSentUniqueOutcome(i),await OneSignal.context.updateManager.sendOutcomeDirect(this.appId,i,this.outcomeName,n);return;case Q.Indirect:this.isUnique&&await this.saveSentUniqueOutcome(i),await OneSignal.context.updateManager.sendOutcomeInfluenced(this.appId,i,this.outcomeName,n);return;case Q.Unattributed:if(this.isUnique){if(await this.wasSentDuringSession()){g.warn("(Unattributed) unique outcome was already sent during this session");return}await this.saveSentUniqueOutcome([])}await OneSignal.context.updateManager.sendOutcomeUnattributed(this.appId,this.outcomeName,n);return;default:g.warn("You are on a free plan. Please upgrade to use this functionality.");return}}static async getAttribution(e){if(e.direct&&e.direct.enabled){const t=await l.getAllNotificationClickedForOutcomes();if(t.length>0)return{type:Q.Direct,notificationIds:[t[0].notificationId]}}if(e.indirect&&e.indirect.enabled){const t=e.indirect.influencedTimePeriodMin*60*1e3,n=new Date(new Date().getTime()-t).getTime(),a=await l.getAllNotificationReceivedForOutcomes();if(g.debug(`	Found total of ${a.length} received notifications`),a.length>0){const o=e.indirect.influencedNotificationsLimit,r=b.sortArrayOfObjects(a,d=>d.timestamp,!0,!1),p=r.filter(d=>d.timestamp>=n).slice(0,o).map(d=>d.notificationId);g.debug(`	Total of ${p.length} received notifications are within reporting window.`);const u=r.filter(d=>p.indexOf(d.notificationId)===-1).map(d=>d.notificationId);if(u.forEach(d=>l.remove(Le,d)),g.debug(`	${u.length} received notifications will be deleted.`),p.length>0)return{type:Q.Indirect,notificationIds:p}}}return e.unattributed&&e.unattributed.enabled?{type:Q.Unattributed,notificationIds:[]}:{type:Q.NotSupported,notificationIds:[]}}}var ge=(s=>(s.Safari="safari",s.Firefox="firefox",s.Chrome="chrome",s.Opera="opera",s.Edge="edge",s.Other="other",s))(ge||{});class bi{static getEnvironmentInfo(){return{browserType:this.getBrowser(),browserVersion:this.getBrowserVersion(),isBrowserAndSupportsServiceWorkers:this.supportsServiceWorkers(),requiresUserInteraction:this.requiresUserInteraction(),osVersion:this.getOsVersion()}}static getBrowser(){return V().name==="chrome"?ge.Chrome:V().name==="msedge"?ge.Edge:V().name==="opera"?ge.Opera:V().name==="firefox"?ge.Firefox:this.isMacOSSafari()?ge.Safari:ge.Other}static isMacOSSafari(){return typeof window.safari<"u"}static getBrowserVersion(){return b.parseVersionString(V().version)}static supportsServiceWorkers(){return window.navigator&&"serviceWorker"in window.navigator}static requiresUserInteraction(){return this.getBrowser()==="firefox"&&this.getBrowserVersion()>=72||this.getBrowser()==="safari"&&this.getBrowserVersion()>=12.1}static getOsVersion(){return Ke.osversion}}var j=(s=>(s[s.NoNativePermission=0]="NoNativePermission",s[s.Subscribed=1]="Subscribed",s[s.UserOptedOut=-2]="UserOptedOut",s[s.NotSubscribed=-10]="NotSubscribed",s[s.TemporaryWebRecord=-20]="TemporaryWebRecord",s[s.PermissionRevoked=-21]="PermissionRevoked",s[s.PushSubscriptionRevoked=-22]="PushSubscriptionRevoked",s[s.ServiceWorkerStatus403=-23]="ServiceWorkerStatus403",s[s.ServiceWorkerStatus404=-24]="ServiceWorkerStatus404",s))(j||{}),Ee=(s=>(s[s.ChromeLike=5]="ChromeLike",s[s.SafariLegacy=7]="SafariLegacy",s[s.Firefox=8]="Firefox",s[s.Email=11]="Email",s[s.Edge=12]="Edge",s[s.SMS=14]="SMS",s[s.SafariVapid=17]="SafariVapid",s))(Ee||{});class X{type;token;enabled;notificationTypes;sdk;deviceModel;deviceOs;webAuth;webp256;constructor(e){const t=bi.getEnvironmentInfo();this.token=this._getToken(e),this.type=X.getSubscriptionType(),this.notificationTypes=j.Subscribed,this.sdk="160306",this.deviceModel=navigator.platform,this.deviceOs=isNaN(t.browserVersion)?-1:t.browserVersion,this.webAuth=e.w3cAuth,this.webp256=e.w3cP256dh}_getToken(e){return e.w3cEndpoint?e.w3cEndpoint.toString():e.safariDeviceToken}serialize(){return{type:this.type,token:this.token,enabled:this.enabled,notification_types:this.notificationTypes,sdk:this.sdk,device_model:this.deviceModel,device_os:this.deviceOs,web_auth:this.webAuth,web_p256:this.webp256}}static getSubscriptionType(){return z.redetectBrowserUserAgent().firefox?J.FirefoxPush:O.useSafariVapidPush()?J.SafariPush:O.useSafariLegacyPush()?J.SafariLegacyPush:J.ChromePush}static getDeviceType(){switch(this.getSubscriptionType()){case J.FirefoxPush:return Ee.Firefox;case J.SafariLegacyPush:return Ee.SafariLegacy;case J.SafariPush:return Ee.SafariVapid}return Ee.ChromeLike}}class _e{constructor(e,t){this.label=e,this.id=t}static ONESIGNAL_ID="onesignal_id";static EXTERNAL_ID="external_id"}class je{static async sendOutcome(e){g.info("Outcome payload:",e);try{await I.post("outcomes/measure",e)}catch(t){g.error("sendOutcome",t)}}}class He{static async downloadServerAppConfig(e){return b.enforceAppId(e),(await I.get(`sync/${e}/web`,null))?.result}static getUserIdFromSubscriptionIdentifier(e,t,i){return b.enforceAppId(e),I.post("players",{app_id:e,device_type:t,identifier:i,notification_types:j.TemporaryWebRecord}).then(n=>n?.result?.id?n.result.id:null).catch(n=>(g.debug("Error getting user ID from subscription identifier:",n),null))}static async updateUserSession(e,t,i){const n=new _e(_e.ONESIGNAL_ID,t),a={refresh_device_metadata:!0,deltas:{session_count:1}};b.enforceAppId(e),b.enforceAlias(n);try{await lt.updateUser({appId:e,subscriptionId:i},n,a)}catch(o){g.debug("Error updating user session:",o)}}static async sendSessionDuration(e,t,i,n,a){const o={refresh_device_metadata:!0,deltas:{session_time:n}},r=new _e(_e.ONESIGNAL_ID,t),p={id:"os__session_duration",app_id:e,session_time:n,notification_ids:a.notificationIds,subscription:{id:i,type:X.getSubscriptionType()},onesignal_id:t};p.direct=a.type===Q.Direct;try{await lt.updateUser({appId:e,subscriptionId:i},r,o),p.notification_ids&&p.notification_ids.length>0&&await je.sendOutcome(p)}catch(u){g.debug("Error sending session duration:",u)}}}class F{static getServiceWorkerHref(e,t,i){return F.appendServiceWorkerParams(e.workerPath.getFullPath(),t,i)}static appendServiceWorkerParams(e,t,i){const n=new URL(e,z.getBaseUrl()).href,a=b.encodeHashAsUriComponent({appId:t}),o=b.encodeHashAsUriComponent({sdkVersion:i});return`${n}?${a}&${o}`}static async upsertSession(e,t,i,n,a,o,r){const p=await l.getCurrentSession();if(!p){const y=It({appId:e}),T=await l.getLastNotificationClickedForOutcomes(e);T&&(y.notificationId=T.notificationId),await l.upsertSession(y),await F.sendOnSessionCallIfNotPlayerCreate(e,t,i,o,y);return}if(p.status===ce.Active){h.debug("Session already active",p);return}if(!p.lastDeactivatedTimestamp){h.debug("Session is in invalid state",p);return}const u=new Date().getTime();if(F.timeInSecondsBetweenTimestamps(u,p.lastDeactivatedTimestamp)<=n){p.status=ce.Active,p.lastActivatedTimestamp=u,p.lastDeactivatedTimestamp=null,await l.upsertSession(p);return}await F.finalizeSession(e,t,i,p,a,r);const m=It({appId:e});await l.upsertSession(m),await F.sendOnSessionCallIfNotPlayerCreate(e,t,i,o,m)}static async deactivateSession(e,t,i,n,a,o){const r=await l.getCurrentSession();if(!r){h.debug("No active session found. Cannot deactivate.");return}const p=()=>F.finalizeSession(e,t,i,r,a,o);if(r.status===ce.Inactive)return $e(p,n);if(r.status!==ce.Active){h.warn(`Session in invalid state ${r.status}. Cannot deactivate.`);return}const u=new Date().getTime(),d=F.timeInSecondsBetweenTimestamps(u,r.lastActivatedTimestamp);r.lastDeactivatedTimestamp=u,r.accumulatedDuration+=d,r.status=ce.Inactive;const m=$e(p,n);return await l.upsertSession(r),m}static async sendOnSessionCallIfNotPlayerCreate(e,t,i,n,a){n!==We.UserCreate&&(l.upsertSession(a),l.resetSentUniqueOutcomes(),await He.updateUserSession(e,t,i))}static async finalizeSession(e,t,i,n,a,o){if(h.debug("Finalize session",`started: ${new Date(n.startTimestamp)}`,`duration: ${n.accumulatedDuration}s`),a){h.debug(`send on_focus reporting session duration -> ${n.accumulatedDuration}s`);const r=await ut.getAttribution(o);h.debug("send on_focus with attribution",r),await He.sendSessionDuration(e,t,i,n.accumulatedDuration,r)}await Promise.all([l.cleanupCurrentSession(),l.removeAllNotificationClickedForOutcomes()]),h.debug("Finalize session finished",`started: ${new Date(n.startTimestamp)}`)}static timeInSecondsBetweenTimestamps(e,t){return e<=t?0:Math.floor((e-t)/1e3)}}var Z=(s=>(s.OneSignalWorker="OneSignal Worker",s.ThirdParty="3rd Party",s.None="None",s))(Z||{});class pe{static QUERY_STRING="?";path;constructor(e){if(!e)throw new S("path",w.Empty);this.path=e.trim()}getQueryString(){const e=this.path.indexOf("?");return e===-1?null:this.path.length>e?this.path.substring(e+1):null}getWithoutQueryString(){return this.path.split(pe.QUERY_STRING)[0]}getFileName(){return this.getWithoutQueryString().split("\\").pop()?.split("/").pop()}getFileNameWithQuery(){return this.path.split("\\").pop()?.split("/").pop()}getFullPath(){return this.path}getPathWithoutFileName(){const e=this.getWithoutQueryString(),t=e.lastIndexOf(this.getFileName());let i=e.substring(0,t);return i=i.replace(/[\\/]$/,""),i}}class dt{context;config;constructor(e,t){this.context=e,this.config=t}async getRegistration(){return Pe.getRegistration(this.config.registrationOptions.scope)}async getOneSignalRegistration(){if(await this.getActiveState()===Z.OneSignalWorker)return this.getRegistration()}async getActiveState(){const e=await this.getRegistration();if(!e)return Z.None;const t=dt.activeSwFileName(e);return this.swActiveStateByFileName(t)}static activeSwFileName(e){const t=Pe.getAvailableServiceWorker(e);if(!t)return null;const i=new URL(t.scriptURL).pathname,n=new pe(i).getFileName();if(n=="akam-sw.js"){const o=new URLSearchParams(new URL(t.scriptURL).search).get("othersw");if(o)return g.debug("Found a ServiceWorker under Akamai's akam-sw.js?othersw=",o),new pe(new URL(o).pathname).getFileName()}return n}swActiveStateByFileName(e){return e?e==this.config.workerPath.getFileName()||e=="OneSignalSDK.sw.js"?Z.OneSignalWorker:Z.ThirdParty:Z.None}async getWorkerVersion(){return new Promise(async e=>{this.context.workerMessenger.once(P.WorkerVersion,t=>{e(t)}),await this.context.workerMessenger.unicast(P.WorkerVersion)})}async shouldInstallWorker(){if(!O.supportsServiceWorkers()||!OneSignal.config)return!1;const e=await this.getActiveState();if(g.debug("[shouldInstallWorker] workerState",e),e===Z.None||e===Z.ThirdParty){const i=await OneSignal.context.permissionManager.getNotificationPermission(OneSignal.config.safariWebId)==="granted";return i&&g.info("[shouldInstallWorker] Notification Permissions enabled, will install ServiceWorker"),i}return await this.haveParamsChanged()?!0:this.workerNeedsUpdate()}async haveParamsChanged(){const e=await this.getRegistration();if(!e)return g.info("[changedServiceWorkerParams] workerRegistration not found at scope",this.config.registrationOptions.scope),!0;const t=new URL(e.scope).pathname,i=this.config.registrationOptions.scope;if(t!=i)return g.info("[changedServiceWorkerParams] ServiceWorker scope changing",{a_old:t,b_new:i}),!0;const n=Pe.getAvailableServiceWorker(e),a=F.getServiceWorkerHref(this.config,this.context.appConfig.appId,O.version());return n?.scriptURL?a!==n.scriptURL?(g.info("[changedServiceWorkerParams] ServiceWorker href changing:",{a_old:n?.scriptURL,b_new:a}),!0):!1:!0}async workerNeedsUpdate(){g.info("[Service Worker Update] Checking service worker version...");let e;try{e=await b.timeoutPromise(this.getWorkerVersion(),2e3)}catch{return g.info("[Service Worker Update] Worker did not reply to version query; assuming older version and updating."),!0}return e!==O.version()?(g.info(`[Service Worker Update] Updating service worker from ${e} --> ${O.version()}.`),!0):(g.info(`[Service Worker Update] Service worker version is current at ${e} (no update required).`),!1)}async establishServiceWorkerChannel(){g.debug("establishServiceWorkerChannel");const e=this.context.workerMessenger;e.off(),e.on(P.NotificationWillDisplay,async i=>{g.debug(location.origin,"Received notification display event from service worker.");const n={notification:i.notification,preventDefault:function(){throw new Error("Browser does not support preventing display.")}};await q.trigger(OneSignal.EVENTS.NOTIFICATION_WILL_DISPLAY,n)}),e.on(P.NotificationClicked,async i=>{OneSignal.emitter.numberOfListeners(OneSignal.EVENTS.NOTIFICATION_CLICKED)===0?(g.debug("notification.clicked event received, but no event listeners; storing event in IndexedDb for later retrieval."),i.result.url,await l.putNotificationClickedEventPendingUrlOpening(i)):await _.triggerNotificationClick(i)}),e.on(P.NotificationDismissed,async i=>{await q.trigger(OneSignal.EVENTS.NOTIFICATION_DISMISSED,i)});const t=z.isSafari();e.on(P.AreYouVisible,async i=>{if(t){const n={timestamp:i.timestamp,focused:document.hasFocus()};await e.directPostMessageToSW(P.AreYouVisibleResponse,n)}})}async installWorker(){if(!await this.shouldInstallWorker())return this.getOneSignalRegistration();g.info("Installing worker..."),await this.getActiveState()===Z.ThirdParty&&g.info("[Service Worker Installation] 3rd party service worker detected.");const t=F.getServiceWorkerHref(this.config,this.context.appConfig.appId,O.version()),i=`${z.getBaseUrl()}${this.config.registrationOptions.scope}`;g.info(`[Service Worker Installation] Installing service worker ${t} ${i}.`);let n;try{n=await navigator.serviceWorker.register(t,{scope:i,type:void 0})}catch(a){g.error(`[Service Worker Installation] Installing service worker failed ${a}`),n=await this.fallbackToUserModelBetaWorker()}return g.debug("[Service Worker Installation] Service worker installed. Waiting for activation"),await Pe.waitUntilActive(n),g.debug("[Service Worker Installation] Service worker active"),await this.establishServiceWorkerChannel(),n}async fallbackToUserModelBetaWorker(){const e="OneSignalSDK.sw.js",t={workerPath:new pe(`/${e}`),registrationOptions:this.config.registrationOptions},i=F.getServiceWorkerHref(t,this.context.appConfig.appId,O.version()),n=`${z.getBaseUrl()}${this.config.registrationOptions.scope}`;g.info(`[Service Worker Installation] Attempting to install v16 Beta Worker ${i} ${n}.`);try{const a=await navigator.serviceWorker.register(i,{scope:n}),o=`
        [Service Worker Installation] Successfully installed v16 Beta Worker.
        Deprecation warning: support for the v16 beta worker name of ${e}
        will be removed May 5 2024. We have decided to keep the v15 name.
        To avoid breaking changes for your users, please host both worker files:
        OneSignalSDK.sw.js & OneSignalSDKWorker.js.
      `;return g.error(o),a}catch(a){const o=await fetch(i);throw o.status===403||o.status===404?new Re(o.status,o.statusText):a}}}var fe=(s=>(s.Default="default",s.Granted="granted",s.Denied="denied",s))(fe||{}),gt=(s=>(s[s.DestroySubscription=0]="DestroySubscription",s[s.MarkUnsubscribed=1]="MarkUnsubscribed",s))(gt||{}),Se=(s=>(s[s.ResubscribeExisting=0]="ResubscribeExisting",s[s.SubscribeNew=1]="SubscribeNew",s))(Se||{});class Ae extends R{constructor(){super("This code is not implemented yet."),Object.setPrototypeOf(this,Ae.prototype)}}var ye=(s=>(s[s.Blocked=0]="Blocked",s[s.Dismissed=1]="Dismissed",s[s.Default=2]="Default",s))(ye||{});class he extends R{reason;constructor(e){let t;switch(e){case 1:t="The user dismissed the permission prompt.";break;case 0:t="Notification permissions are blocked.";break;case 2:t="Notification permissions have not been granted yet.";break}super(t),this.reason=e,Object.setPrototypeOf(this,he.prototype)}}var Mt=(s=>(s[s.InvalidSafariSetup=0]="InvalidSafariSetup",s[s.Blocked=1]="Blocked",s[s.Dismissed=2]="Dismissed",s))(Mt||{});class pt extends R{constructor(e){let t;switch(e){case 0:t="The Safari site URL, icon size, or push certificate is invalid, or Safari is in a private session.";break;case 1:t="Notification permissions are blocked.";break;case 2:t="The notification permission prompt was dismissed.";break}super(t),Object.setPrototypeOf(this,pt.prototype)}}class oe{w3cEndpoint;w3cP256dh;w3cAuth;safariDeviceToken;static setFromW3cSubscription(e){const t=new oe;if(e&&(t.w3cEndpoint=new URL(e.endpoint),e.getKey)){let i=null;try{i=e.getKey("p256dh")}catch{}let n=null;try{n=e.getKey("auth")}catch{}if(i){const a=btoa(String.fromCharCode.apply(null,new Uint8Array(i)));t.w3cP256dh=a}if(n){const a=btoa(String.fromCharCode.apply(null,new Uint8Array(n)));t.w3cAuth=a}}return t}setFromSafariSubscription(e){e&&(this.safariDeviceToken=e)}serialize(){return{w3cEndpoint:this.w3cEndpoint?this.w3cEndpoint.toString():null,w3cP256dh:this.w3cP256dh,w3cAuth:this.w3cAuth,safariDeviceToken:this.safariDeviceToken}}static deserialize(e){const t=new oe;if(!e)return t;try{t.w3cEndpoint=new URL(e.w3cEndpoint)}catch{}return t.w3cP256dh=e.w3cP256dh,t.w3cAuth=e.w3cAuth,t.safariDeviceToken=e.safariDeviceToken,t}}const mi="99999999-9999-9999-9999-999999999999";class ie{context;config;safariPermissionPromptFailed=!1;constructor(e,t){this.context=e,this.config=t}async isPushNotificationsEnabled(){const e=await this.getSubscriptionState();return e.subscribed&&!e.optedOut}async isOptedIn(){const e=await this.getSubscriptionState();return await OneSignal.context.permissionManager.getPermissionStatus()==="granted"&&!e.optedOut}async isOptedOut(e){v("isOptedOut",e);const{optedOut:t}=await l.getSubscription();return si(e,t),t}async subscribe(e){const t=k.getWindowEnv();let i;switch(t){case W.ServiceWorker:i=await this.subscribeFcmFromWorker(e);break;case W.Host:if(await OneSignal.context.permissionManager.getPermissionStatus()===fe.Denied)throw new he(ye.Blocked);if(O.useSafariLegacyPush()){i=await this.subscribeSafari(),await this._updatePushSubscriptionModelWithRawSubscription(i),g.info("Installing SW on Safari");try{await this.context.serviceWorkerManager.installWorker(),g.info("SW on Safari successfully installed")}catch{g.error("SW on Safari failed to install.")}}else i=await this.subscribeFcmFromPage(e),await this._updatePushSubscriptionModelWithRawSubscription(i);break;default:throw new ue(le.UnsupportedEnvironment)}return i}async _updatePushSubscriptionModelWithRawSubscription(e){const t=await OneSignal.coreDirector.getPushSubscriptionModel();if(t){const i=new X(e).serialize(),n=Object.keys(i);for(let a=0;a<n.length;a++){const o=n[a];i[o]&&t.set(o,i[o])}}else{OneSignal.coreDirector.generatePushSubscriptionModel(e),await L.createAndHydrateUser();return}}async updateNotificationTypes(){const e=await this.getNotificationTypes();await this.updatePushSubscriptionNotificationTypes(e)}async getNotificationTypes(){const{optedOut:e}=await l.getSubscription();return e?j.UserOptedOut:await OneSignal.context.permissionManager.getPermissionStatus()==="granted"?j.Subscribed:j.NoNativePermission}async updatePushSubscriptionNotificationTypes(e){const t=await OneSignal.coreDirector.getPushSubscriptionModel();if(!t){g.info("No Push Subscription yet to update notification_types.");return}t.set("notification_types",e),t.set("enabled",e===j.Subscribed)}async registerSubscription(e,t){e&&(e=oe.deserialize(e)),await this.isAlreadyRegisteredWithOneSignal()?await this.context.updateManager.sendPushDeviceRecordUpdate():this.context.sessionManager.upsertSession(We.UserCreate);const i=await l.getSubscription();return i.deviceId=mi,i.optedOut=!1,e?O.useSafariLegacyPush()?i.subscriptionToken=e.safariDeviceToken:i.subscriptionToken=e.w3cEndpoint?e.w3cEndpoint.toString():null:i.subscriptionToken=null,await l.setSubscription(i),k.getWindowEnv()!==W.ServiceWorker&&q.trigger(OneSignal.EVENTS.REGISTERED),typeof OneSignal<"u"&&(OneSignal._sessionInitAlreadyRunning=!1),i}static async requestPresubscribeNotificationPermission(){return await ie.requestNotificationPermission()}async unsubscribe(e){if(e===gt.DestroySubscription)throw new Ae;if(e===gt.MarkUnsubscribed)if(k.getWindowEnv()===W.ServiceWorker)await l.put("Options",{key:"optedOut",value:!0});else throw new Ae;else throw new Ae}static async requestNotificationPermission(){return await window.Notification.requestPermission()}async isAlreadyRegisteredWithOneSignal(){const{deviceId:e}=await l.getSubscription();return!!e}async subscribeSafariPromptPermission(){const e=t=>new Promise(i=>{window.safari.pushNotification.requestPermission(t,this.config.safariWebId,{app_id:this.config.appId},n=>{n&&n.deviceToken?i(n.deviceToken.toLowerCase()):i(null)})});return this.safariPermissionPromptFailed?e(`${k.getOneSignalApiUrl().toString()}/safari`):e(`${k.getOneSignalApiUrl().toString()}/safari/apps/${this.config.appId}`)}async subscribeSafari(){const e=new oe;if(!this.config.safariWebId)throw new ae(se.MissingSafariWebId);const{deviceToken:t}=window.safari.pushNotification.permission(this.config.safariWebId);if(t)return e.setFromSafariSubscription(t.toLowerCase()),e;q.trigger(OneSignal.EVENTS.PERMISSION_PROMPT_DISPLAYED);const i=await this.subscribeSafariPromptPermission();if(ne.triggerNotificationPermissionChanged(),i)e.setFromSafariSubscription(i);else throw this.safariPermissionPromptFailed=!0,new pt(Mt.InvalidSafariSetup);return e}async subscribeFcmFromPage(e){if(k.getWindowEnv()===W.Host&&Notification.permission===fe.Default){await q.trigger(OneSignal.EVENTS.PERMISSION_PROMPT_DISPLAYED);const i=await ie.requestPresubscribeNotificationPermission(),n=i===fe.Default;switch(await ne.triggerNotificationPermissionChanged(n),i){case fe.Default:throw g.debug("Exiting subscription and not registering worker because the permission was dismissed."),OneSignal._sessionInitAlreadyRunning=!1,new he(ye.Dismissed);case fe.Denied:throw g.debug("Exiting subscription and not registering worker because the permission was blocked."),OneSignal._sessionInitAlreadyRunning=!1,new he(ye.Blocked)}}let t;try{t=await this.context.serviceWorkerManager.installWorker()}catch(i){throw i instanceof Re&&(i.status===403?await this.context.subscriptionManager.registerFailedSubscription(j.ServiceWorkerStatus403,this.context):i.status===404&&await this.context.subscriptionManager.registerFailedSubscription(j.ServiceWorkerStatus404,this.context)),i}if(!t)throw new Error("OneSignal service worker not found!");return g.debug("[Subscription Manager] Service worker is ready to continue subscribing."),await this.subscribeWithVapidKey(t.pushManager,e)}async subscribeFcmFromWorker(e){const t=self.registration;if(!t.active&&V().name!=="firefox")throw new ue(le.ServiceWorkerNotActivated);const i=await t.pushManager.permissionState({userVisibleOnly:!0});if(i==="denied")throw new he(ye.Blocked);if(i==="prompt")throw new he(ye.Default);return await this.subscribeWithVapidKey(t.pushManager,e)}getVapidKeyForBrowser(){let e;if(V().name==="firefox"?e=this.config.onesignalVapidPublicKey:e=this.config.vapidPublicKey,e)return pi(e).buffer}async subscribeWithVapidKey(e,t){const i=await e.getSubscription();switch(t){case Se.ResubscribeExisting:if(!i)break;i.options?g.debug("[Subscription Manager] An existing push subscription exists and it's options is not null."):(g.debug("[Subscription Manager] An existing push subscription exists and options is null. Unsubscribing from push first now."),await ie.doPushUnsubscribe(i));break;case Se.SubscribeNew:i&&await ie.doPushUnsubscribe(i);break}const[n,a]=await ie.doPushSubscribe(e,this.getVapidKeyForBrowser());return await ie.updateSubscriptionTime(a,n.expirationTime),oe.setFromW3cSubscription(n)}static async updateSubscriptionTime(e,t){const i=await l.getSubscription();e&&(i.createdAt=new Date().getTime()),i.expirationTime=t,await l.setSubscription(i)}static async doPushUnsubscribe(e){g.debug("[Subscription Manager] Unsubscribing existing push subscription.");const t=await e.unsubscribe();return g.debug(`[Subscription Manager] Unsubscribing existing push subscription result: ${t}`),t}static async doPushSubscribe(e,t){if(!t)throw new Error("Missing required 'applicationServerKey' to subscribe for push notifications!");const i={userVisibleOnly:!0,applicationServerKey:t};g.debug("[Subscription Manager] Subscribing to web push with these options:",i);try{const n=await e.getSubscription();return[await e.subscribe(i),!n]}catch(n){if(n.name=="InvalidStateError"){g.warn("[Subscription Manager] Couldn't re-subscribe due to applicationServerKey changing, unsubscribe and attempting to subscribe with new key.",n);const a=await e.getSubscription();return a&&await ie.doPushUnsubscribe(a),[await e.subscribe(i),!0]}else throw n}}async isSubscriptionExpiring(){if(await this.context.serviceWorkerManager.getActiveState()!==Z.OneSignalWorker)return!1;const t=await this.context.serviceWorkerManager.getOneSignalRegistration();if(!t||!t.pushManager)return!1;const i=await t.pushManager.getSubscription();if(!i||!i.expirationTime)return!1;let{createdAt:n}=await l.getSubscription();n||(n=new Date().getTime()+31536e6);const a=n+(i.expirationTime-n)/2;return!!i.expirationTime&&(new Date().getTime()>=i.expirationTime||new Date().getTime()>=a)}async getSubscriptionState(){switch(k.getWindowEnv()){case W.ServiceWorker:{const t=await self.registration.pushManager.getSubscription(),{optedOut:i}=await l.getSubscription();return{subscribed:!!t,optedOut:!!i}}default:return this.getSubscriptionStateFromBrowserContext()}}async getSubscriptionStateFromBrowserContext(){const{optedOut:e,subscriptionToken:t}=await l.getSubscription(),i=await OneSignal.coreDirector.getPushSubscriptionModel(),n=de(i?.data)&&!!i?.onesignalId;if(O.useSafariLegacyPush()){const p=window.safari?.pushNotification?.permission(this.config.safariWebId);return{subscribed:!!(n&&t&&p?.permission==="granted"&&p?.deviceToken),optedOut:!!e}}const a=await this.context.serviceWorkerManager.getOneSignalRegistration(),o=await this.context.permissionManager.getNotificationPermission(this.context.appConfig.safariWebId);return a?{subscribed:!!(n&&t&&o===fe.Granted),optedOut:!!e}:{subscribed:!1,optedOut:!!e}}async registerFailedSubscription(e,t){t.pageViewManager.isFirstPageView()&&(t.subscriptionManager.registerSubscription(new oe,e),t.pageViewManager.incrementPageViewCount())}}class Dt{static getServiceWorkerManager(e){const t=e.appConfig,i={workerPath:new pe("OneSignalSDKWorker.js"),registrationOptions:{scope:"/"}};return t.userConfig&&(t.userConfig.path&&(i.workerPath=new pe(`${t.userConfig.path}${t.userConfig.serviceWorkerPath}`)),t.userConfig.serviceWorkerParam&&(i.registrationOptions=t.userConfig.serviceWorkerParam)),new dt(e,i)}static getSubscriptionManager(e){const t=e.appConfig,i={safariWebId:t.safariWebId,appId:t.appId,vapidPublicKey:t.vapidPublicKey,onesignalVapidPublicKey:t.onesignalVapidPublicKey};return new ie(e,i)}}class wi{context;onSessionSent;constructor(e){this.context=e,this.onSessionSent=e.pageViewManager.getPageViewCount()>1}async sendPushDeviceRecordUpdate(){if(!A.singletonInstance?.hasOneSignalId){g.debug("Not sending the update because user is not registered with OneSignal (no onesignal_id)");return}this.onSessionSent||await this.sendOnSessionUpdate()}async sendOnSessionUpdate(){if(this.onSessionSent||!this.context.pageViewManager.isFirstPageView())return;if(!await this.context.subscriptionManager.isAlreadyRegisteredWithOneSignal()){g.debug("Not sending the on session because user is not registered with OneSignal (no device id)");return}if(!((await OneSignal.coreDirector.getPushSubscriptionModel())?.data.notification_types!==j.Subscribed&&OneSignal.config?.enableOnSession!==!0))try{this.context.sessionManager.upsertSession(We.UserNewSession),this.onSessionSent=!0}catch(i){g.error(`Failed to update user session. Error "${i.message}" ${i.stack}`)}}async sendOutcomeDirect(e,t,i,n){v("sendOutcomeDirect");const a=await OneSignal.coreDirector.getPushSubscriptionModel();if(a&&de(a?.data)){const o={id:i,app_id:e,notification_ids:t,direct:!0,subscription:{id:a.data.id,type:X.getSubscriptionType()}};n!==void 0&&(o.weight=n),await je.sendOutcome(o);return}g.warn("Send outcome aborted because pushSubscriptionModel is not available.")}async sendOutcomeInfluenced(e,t,i,n){v("sendOutcomeInfluenced");const a=await OneSignal.coreDirector.getPushSubscriptionModel();if(a&&de(a?.data)){const o={id:i,app_id:e,notification_ids:t,direct:!1,subscription:{id:a.data.id,type:X.getSubscriptionType()}};n!==void 0&&(o.weight=n),await je.sendOutcome(o);return}g.warn("Send outcome aborted because pushSubscriptionModel is not available.")}async sendOutcomeUnattributed(e,t,i){v("sendOutcomeUnattributed");const n=await OneSignal.coreDirector.getPushSubscriptionModel();if(n&&de(n?.data)){const a={id:t,app_id:e,subscription:{id:n.data.id,type:X.getSubscriptionType()}};i!==void 0&&(a.weight=i),await je.sendOutcome(a);return}g.warn("Send outcome aborted because pushSubscriptionModel is not available.")}}class Si{async upsertSession(e){}async setupSessionEventListeners(){}}class ft{appConfig;subscriptionManager;serviceWorkerManager;pageViewManager;sessionManager;permissionManager;workerMessenger;updateManager;constructor(e){this.appConfig=e,this.subscriptionManager=Dt.getSubscriptionManager(this),this.serviceWorkerManager=Dt.getServiceWorkerManager(this),this.pageViewManager=new De,this.sessionManager=new Si,this.permissionManager=new Ye,this.workerMessenger=new wt(this),this.updateManager=new wi(this)}}const ht={reportingThreshold:30,enableOnSessionForUnsubcribed:!1,enableOnFocus:!0},G={pageViews:1,timeDelay:0},ee={actionMessage:"We'd like to show you notifications for the latest news and updates.",acceptButton:"Allow",cancelButton:"Cancel",categoryDefaults:{updateMessage:"Update your push notification subscription preferences.",positiveUpdateButton:"Save Preferences",negativeUpdateButton:"Cancel"},confirmMessage:"Thank You!"},yi={type:Y.Push,text:{actionMessage:ee.actionMessage,acceptButton:ee.acceptButton,cancelButton:ee.cancelButton},autoPrompt:!1,delay:G};var ze=(s=>(s.TypicalSite="typical",s.WordPress="wordpress",s.Shopify="shopify",s.Blogger="blogger",s.Magento="magento",s.Drupal="drupal",s.SquareSpace="squarespace",s.Joomla="joomla",s.Weebly="weebly",s.Wix="wix",s.Custom="custom",s))(ze||{});class Ce{static convertTagsApiToBooleans(e){const t={};return Object.keys(e).forEach(i=>{t[i]=e[i]==="1"}),t}static convertTagsBooleansToApi(e){const t={};return Object.keys(e).forEach(i=>{t[i]=e[i]===!0?"1":"0"}),t}static getObjectDifference(e,t){const i={};return Object.keys(e).forEach(n=>{t[n]!==e[n]&&(i[n]=e[n])}),i}static markAllTagsAsSpecified(e,t){e.forEach(i=>{i.checked=t})}static isTagObjectEmpty(e){return Object.keys(e).length===0}static getCheckedTagCategories(e,t){if(!t)return e;if(Ce.isTagObjectEmpty(t)){const a=it(e);return Ce.markAllTagsAsSpecified(a,!0),a}return it(e).map(a=>{const o=t[a.tag];return a.checked=Ce.getCheckedStatusForTagValue(o),a})}static getCheckedStatusForTagValue(e){return e===void 0?!0:e}static limitCategoriesToMaxCount(e,t){let i=it(e);return i=e.slice(0,t),i}}class ve{static upgradeConfigToVersionTwo(e){ve.isPromptOptionsVersion0(e.promptOptions)&&(e.promptOptions=ve.convertConfigToVersionOne(e.promptOptions)),ve.isSlidedownConfigVersion1(e.promptOptions?.slidedown)&&e.promptOptions?.slidedown&&(e.promptOptions.slidedown=ve.convertConfigToVersionTwo(e.promptOptions?.slidedown))}static convertConfigToVersionOne(e){e.slidedown||(e.slidedown={});const{acceptButtonText:t,cancelButtonText:i,actionMessage:n}=e.slidedown,a=e.acceptButtonText||e.acceptButton,o=e.cancelButtonText||e.cancelButton;return e.slidedown.acceptButtonText=t||a,e.slidedown.cancelButtonText=i||o,e.slidedown.actionMessage=n||e.actionMessage,e}static convertConfigToVersionTwo(e){const t=me.isCategorySlidedownConfiguredVersion1(e)?Y.Category:Y.Push;let i,n;return t===Y.Category&&(i=e.categories?.positiveUpdateButton,n=e.categories?.negativeUpdateButton),{prompts:[...e.prompts||[],{type:t,autoPrompt:e.autoPrompt,text:{actionMessage:e.actionMessage,acceptButton:e.acceptButton||e.acceptButtonText,cancelButton:e.cancelButton||e.cancelButtonText,positiveUpdateButton:i,negativeUpdateButton:n,updateMessage:e?.categories?.updateMessage},delay:{pageViews:e.pageViews,timeDelay:e.timeDelay},categories:e?.categories?.tags}]}}static isPromptOptionsVersion0(e){if(e){const t=["acceptButtonText","cancelButtonText","actionMessage"];for(let i=0;i<t.length;i++)if(e.hasOwnProperty(t[i]))return!0}return!1}static isSlidedownConfigVersion1(e){if(e){const t=["enabled","autoPrompt","pageViews","timeDelay","acceptButton","acceptButtonText","cancelButton","cancelButtonText","actionMessage","customizeTextEnabled","categories"];for(let i=0;i<t.length;i++)if(e.hasOwnProperty(t[i]))return!0}return!1}}const vi=10;class Oi{static async getAppConfig(e,t){try{if(!e||!e.appId||!z.isValidUuid(e.appId))throw new ae(se.InvalidAppId);const i=await t(e.appId);ve.upgradeConfigToVersionTwo(e);const n=this.getMergedConfig(e,i);return this.checkUnsupportedSubdomain(n),this.checkRestrictedOrigin(n),n}catch(i){if(i){if(i.code===1)throw new ae(se.InvalidAppId);if(i.code===2)throw new ae(se.AppNotConfiguredForWebPush)}throw i}}static checkUnsupportedSubdomain(e){const t=!self.isSecureContext;if(e.hasUnsupportedSubdomain||t)throw t?new Error("OneSignalSDK: HTTP sites are no longer supported starting with version 16 (User Model), your public site must start with https://. Please visit the OneSignal dashboard's Settings > Web Configuration to find this option."):new Error(`OneSignalSDK: The "My site is not fully HTTPS" option is no longer supported starting with version 16 (User Model) of the OneSignal SDK. Please visit the OneSignal dashboard's Settings > Web Configuration to find this option.`)}static checkRestrictedOrigin(e){if(e.restrictedOriginEnabled&&k.getWindowEnv()===W.Host&&!this.doesCurrentOriginMatchConfigOrigin(e.origin))throw new ae(se.WrongSiteUrl,{siteUrl:e.origin})}static doesCurrentOriginMatchConfigOrigin(e){try{return location.origin===new URL(e).origin}catch{return!1}}static getIntegrationCapabilities(e){switch(e){case ze.Custom:case ze.WordPress:return{configuration:1};default:return{configuration:0}}}static getMergedConfig(e,t){const i=this.getConfigIntegrationKind(t),n=this.hasUnsupportedSubdomainForConfigIntegrationKind(i,e,t),a=this.getUserConfigForConfigIntegrationKind(i,e,t);return{appId:t.app_id,hasUnsupportedSubdomain:n,siteName:t.config.siteInfo.name,origin:t.config.origin,restrictedOriginEnabled:t.features.restrict_origin&&t.features.restrict_origin.enable,safariWebId:t.config.safari_web_id,vapidPublicKey:t.config.vapid_public_key,onesignalVapidPublicKey:t.config.onesignal_vapid_public_key,userConfig:a,enableOnSession:b.valueOrDefault(t.features.enable_on_session,ht.enableOnSessionForUnsubcribed),sessionThreshold:b.valueOrDefault(t.features.session_threshold,ht.reportingThreshold),enableSessionDuration:b.valueOrDefault(t.features.web_on_focus_enabled,ht.enableOnFocus)}}static getConfigIntegrationKind(e){return e.config.integration?e.config.integration.kind:ze.Custom}static getCustomLinkConfig(e){const t={enabled:!1,style:"button",size:"medium",unsubscribeEnabled:!1,text:{explanation:"",subscribe:"",unsubscribe:""},color:{button:"",text:""}};if(!e||!e.config||!e.config.staticPrompts||!e.config.staticPrompts.customlink||!e.config.staticPrompts.customlink.enabled)return t;const i=e.config.staticPrompts.customlink;return{enabled:i.enabled,style:i.style,size:i.size,unsubscribeEnabled:i.unsubscribeEnabled,text:i.text?{subscribe:i.text.subscribe,unsubscribe:i.text.unsubscribe,explanation:i.text.explanation}:t.text,color:i.color?{button:i.color.button,text:i.color.text}:t.color}}static injectDefaultsIntoPromptOptions(e,t,i){let n={enabled:!1};e&&e.customlink&&(n=e.customlink);const a=t.customlink,o={...e,customlink:{enabled:b.getValueOrDefault(n.enabled,a.enabled),style:b.getValueOrDefault(n.style,a.style),size:b.getValueOrDefault(n.size,a.size),unsubscribeEnabled:b.getValueOrDefault(n.unsubscribeEnabled,a.unsubscribeEnabled),text:{subscribe:b.getValueOrDefault(n.text?n.text.subscribe:void 0,a.text.subscribe),unsubscribe:b.getValueOrDefault(n.text?n.text.unsubscribe:void 0,a.text.unsubscribe),explanation:b.getValueOrDefault(n.text?n.text.explanation:void 0,a.text.explanation)},color:{button:b.getValueOrDefault(n.color?n.color.button:void 0,a.color.button),text:b.getValueOrDefault(n.color?n.color.text:void 0,a.color.text)}}};return o.slidedown?o.slidedown.prompts=o.slidedown?.prompts?.map(r=>{if(r.type=b.getValueOrDefault(r.type,Y.Push),r.type===Y.Category&&(r.text={...r.text,positiveUpdateButton:b.getValueOrDefault(r.text?.positiveUpdateButton,ee.categoryDefaults.positiveUpdateButton),negativeUpdateButton:b.getValueOrDefault(r.text?.negativeUpdateButton,ee.categoryDefaults.negativeUpdateButton),updateMessage:b.getValueOrDefault(r.text?.updateMessage,ee.categoryDefaults.updateMessage)}),r.text={...r.text,actionMessage:b.getValueOrDefault(r.text?.actionMessage,ee.actionMessage),acceptButton:b.getValueOrDefault(r.text?.acceptButton,ee.acceptButton),cancelButton:b.getValueOrDefault(r.text?.cancelButton,ee.cancelButton),confirmMessage:b.getValueOrDefault(r.text?.confirmMessage,ee.confirmMessage)},r.autoPrompt=b.getValueOrDefault(r.autoPrompt,!0),r.delay={pageViews:b.getValueOrDefault(r.delay?.pageViews,G.pageViews),timeDelay:b.getValueOrDefault(r.delay?.timeDelay,G.timeDelay)},r.categories){const{categories:p}=r;r.categories=Ce.limitCategoriesToMaxCount(p,vi)}return r}):(o.slidedown={prompts:[]},o.slidedown.prompts=[yi]),o.native?(o.native.enabled=!!o.native.enabled,o.native.autoPrompt=o.native.hasOwnProperty("autoPrompt")?!!o.native.enabled&&!!o.native.autoPrompt:!!o.native.enabled,o.native.pageViews=b.getValueOrDefault(o.native.pageViews,G.pageViews),o.native.timeDelay=b.getValueOrDefault(o.native.timeDelay,G.timeDelay)):o.native={enabled:!1,autoPrompt:!1,pageViews:G.pageViews,timeDelay:G.timeDelay},i.autoRegister===!0&&(o.native.enabled=!0,o.native.autoPrompt=!0),o.autoPrompt=o.native.autoPrompt||me.isSlidedownAutoPromptConfigured(o.slidedown.prompts),o}static getPromptOptionsForDashboardConfiguration(e){const t=e.config.staticPrompts,i=t.native?{enabled:t.native.enabled,autoPrompt:t.native.enabled&&t.native.autoPrompt!==!1,pageViews:b.getValueOrDefault(t.native.pageViews,G.pageViews),timeDelay:b.getValueOrDefault(t.native.timeDelay,G.timeDelay)}:{enabled:!1,autoPrompt:!1,pageViews:G.pageViews,timeDelay:G.timeDelay},{prompts:n}=t.slidedown;return{autoPrompt:i.autoPrompt||me.isSlidedownAutoPromptConfigured(n),native:i,slidedown:{prompts:n},fullscreen:{enabled:t.fullscreen.enabled,actionMessage:t.fullscreen.actionMessage,acceptButton:t.fullscreen.acceptButton,cancelButton:t.fullscreen.cancelButton,title:t.fullscreen.title,message:t.fullscreen.message,caption:t.fullscreen.caption,autoAcceptTitle:t.fullscreen.autoAcceptTitle},customlink:this.getCustomLinkConfig(e)}}static getServiceWorkerValues(e,t){const i=e.serviceWorkerOverrideForTypical,n=i?b.getValueOrDefault(e.path,t.config.serviceWorker.path):t.config.serviceWorker.path,a=i?b.getValueOrDefault(e.serviceWorkerParam,{scope:t.config.serviceWorker.registrationScope}):{scope:t.config.serviceWorker.registrationScope},o=i?b.getValueOrDefault(e.serviceWorkerPath,t.config.serviceWorker.workerName):t.config.serviceWorker.workerName;return{path:n,serviceWorkerParam:a,serviceWorkerPath:o}}static getUserConfigForConfigIntegrationKind(e,t,i){switch(this.getIntegrationCapabilities(e).configuration){case 0:{const{path:a,serviceWorkerPath:o,serviceWorkerParam:r}=this.getServiceWorkerValues(t,i);return{appId:i.app_id,autoRegister:!1,autoResubscribe:i.config.autoResubscribe,path:a,serviceWorkerPath:o,serviceWorkerParam:r,subdomainName:i.config.siteInfo.proxyOrigin,promptOptions:this.getPromptOptionsForDashboardConfiguration(i),welcomeNotification:{disable:!i.config.welcomeNotification.enable,title:i.config.welcomeNotification.title,message:i.config.welcomeNotification.message,url:i.config.welcomeNotification.url},notifyButton:{enable:i.config.staticPrompts.bell.enabled,displayPredicate:i.config.staticPrompts.bell.hideWhenSubscribed?()=>!OneSignal.User.PushSubscription.optedIn:null,size:i.config.staticPrompts.bell.size,position:i.config.staticPrompts.bell.location,showCredit:!1,offset:{bottom:`${i.config.staticPrompts.bell.offset.bottom}px`,left:`${i.config.staticPrompts.bell.offset.left}px`,right:`${i.config.staticPrompts.bell.offset.right}px`},colors:{"circle.background":i.config.staticPrompts.bell.color.main,"circle.foreground":i.config.staticPrompts.bell.color.accent,"badge.background":"black","badge.foreground":"white","badge.bordercolor":"black","pulse.color":i.config.staticPrompts.bell.color.accent,"dialog.button.background.hovering":i.config.staticPrompts.bell.color.main,"dialog.button.background.active":i.config.staticPrompts.bell.color.main,"dialog.button.background":i.config.staticPrompts.bell.color.main,"dialog.button.foreground":"white"},text:{"tip.state.unsubscribed":i.config.staticPrompts.bell.tooltip.unsubscribed,"tip.state.subscribed":i.config.staticPrompts.bell.tooltip.subscribed,"tip.state.blocked":i.config.staticPrompts.bell.tooltip.blocked,"message.prenotify":i.config.staticPrompts.bell.tooltip.unsubscribed,"message.action.subscribing":i.config.staticPrompts.bell.message.subscribing,"message.action.subscribed":i.config.staticPrompts.bell.message.subscribing,"message.action.resubscribed":i.config.staticPrompts.bell.message.subscribing,"message.action.unsubscribed":i.config.staticPrompts.bell.message.unsubscribing,"dialog.main.title":i.config.staticPrompts.bell.dialog.main.title,"dialog.main.button.subscribe":i.config.staticPrompts.bell.dialog.main.subscribeButton,"dialog.main.button.unsubscribe":i.config.staticPrompts.bell.dialog.main.unsubscribeButton,"dialog.blocked.title":i.config.staticPrompts.bell.dialog.blocked.title,"dialog.blocked.message":i.config.staticPrompts.bell.dialog.blocked.message}},persistNotification:i.config.notificationBehavior?i.config.notificationBehavior.display.persist:void 0,webhooks:{cors:i.config.webhooks.corsEnable,"notification.willDisplay":i.config.webhooks.notificationDisplayedHook,"notification.clicked":i.config.webhooks.notificationClickedHook,"notification.dismissed":i.config.webhooks.notificationDismissedHook},notificationClickHandlerMatch:i.config.notificationBehavior?i.config.notificationBehavior.click.match:void 0,notificationClickHandlerAction:i.config.notificationBehavior?i.config.notificationBehavior.click.action:void 0,allowLocalhostAsSecureOrigin:i.config.setupBehavior?i.config.setupBehavior.allowLocalhostAsSecureOrigin:void 0,outcomes:{direct:i.config.outcomes.direct,indirect:{enabled:i.config.outcomes.indirect.enabled,influencedTimePeriodMin:i.config.outcomes.indirect.notification_attribution.minutes_since_displayed,influencedNotificationsLimit:i.config.outcomes.indirect.notification_attribution.limit},unattributed:i.config.outcomes.unattributed}}}case 1:{const a={scope:"/"},r={...t,promptOptions:this.injectDefaultsIntoPromptOptions(t.promptOptions,i.config.staticPrompts,t),serviceWorkerParam:t.serviceWorkerParam?t.serviceWorkerParam:a,serviceWorkerPath:t.serviceWorkerPath?t.serviceWorkerPath:"OneSignalSDKWorker.js",path:t.path?t.path:"/",outcomes:{direct:i.config.outcomes.direct,indirect:{enabled:i.config.outcomes.indirect.enabled,influencedTimePeriodMin:i.config.outcomes.indirect.notification_attribution.minutes_since_displayed,influencedNotificationsLimit:i.config.outcomes.indirect.notification_attribution.limit},unattributed:i.config.outcomes.unattributed}};return t.hasOwnProperty("autoResubscribe")?r.autoResubscribe=!!t.autoResubscribe:t.hasOwnProperty("autoRegister")?r.autoResubscribe=!!t.autoRegister:r.autoResubscribe=!!i.config.autoResubscribe,r}}}static hasUnsupportedSubdomainForConfigIntegrationKind(e,t,i){switch(this.getIntegrationCapabilities(e).configuration){case 0:return i.config.siteInfo.proxyOriginEnabled;case 1:return!!t.subdomainName}}}class Rt{static toOSNotification(e){return{notificationId:e.custom.i,title:e.title,body:e.alert,additionalData:e.custom.a,launchURL:e.custom.u,confirmDelivery:e.custom.rr==="y",icon:e.icon,image:e.image,actionButtons:this.convertButtons(e.o),topic:e.tag,badgeIcon:e.badge}}static convertButtons(e){return e?.map(t=>({actionId:t.i,text:t.n,icon:t.p,launchURL:t.u}))}static isValid(e){return typeof e?.custom?.i=="string"}}class Ii{static async getPushSubscriptionIdByToken(e){const t=await l.getAll(x.Subscriptions);for(const i of t)if(i.token===e)return i.id}}class ki{static toNative(e){return e?.map(t=>({action:t.actionId,title:t.text,icon:t.icon}))}}class Pi{async send(e){const t=await l.get("Options",`webhooks.${e.event}`);if(!t)return;const i=await l.get("Options","webhooks.cors"),n={method:"post",mode:"no-cors",body:JSON.stringify(e)};i&&(n.mode="cors",n.headers={"X-OneSignal-Event":e.event,"Content-Type":"application/json"}),h.debug(`Executing ${e.event} webhook ${i?"with":"without"} CORS POST ${t}`,e),await fetch(t,n)}}class xi{event="notification.clicked";notificationId;heading;content;additionalData;actionId;url;subscriptionId;constructor(e,t){const i=e.notification;this.notificationId=i.notificationId,this.heading=i.title,this.content=i.body,this.additionalData=i.additionalData,this.actionId=e.result.actionId,this.url=e.result.url,this.subscriptionId=t}}class Ni{event="notification.willDisplay";notificationId;heading;content;additionalData;actionId;url;subscriptionId;constructor(e,t){this.notificationId=e.notificationId,this.heading=e.title,this.content=e.body,this.additionalData=e.additionalData,this.url=e.launchURL,this.subscriptionId=t}}class Ti{event="notification.dismissed";notificationId;heading;content;additionalData;actionId;url;subscriptionId;constructor(e,t){this.notificationId=e.notificationId,this.heading=e.title,this.content=e.body,this.additionalData=e.additionalData,this.url=e.launchURL,this.subscriptionId=t}}class Ei{constructor(e=new Pi){this.sender=e}async click(e,t){return await this.sender.send(new xi(e,t))}async willDisplay(e,t){return await this.sender.send(new Ni(e,t))}async dismiss(e,t){return await this.sender.send(new Ti(e,t))}}const Ai=25;class f{static get VERSION(){return O.version()}static get environment(){return O}static get log(){return h}static get database(){return l}static get webhookNotificationEventSender(){return new Ei}static async getPushSubscriptionId(){const t=(await self.registration.pushManager.getSubscription())?.endpoint;if(t)return Ii.getPushSubscriptionIdByToken(t)}static get workerMessenger(){return self.workerMessenger||(self.workerMessenger=new wt),self.workerMessenger}static run(){self.addEventListener("activate",f.onServiceWorkerActivated),self.addEventListener("push",f.onPushReceived),self.addEventListener("notificationclose",e=>e.waitUntil(f.onNotificationClosed(e))),self.addEventListener("notificationclick",e=>e.waitUntil(f.onNotificationClicked(e))),self.addEventListener("pushsubscriptionchange",e=>{e.waitUntil(f.onPushSubscriptionChange(e))}),self.addEventListener("message",e=>{const t=e.data,i=t?.payload;switch(t?.command){case P.SessionUpsert:h.debug("[Service Worker] Received SessionUpsert",i),f.debounceRefreshSession(e,i);break;case P.SessionDeactivate:h.debug("[Service Worker] Received SessionDeactivate",i),f.debounceRefreshSession(e,i);break;default:return}}),h.debug("Setting up message listeners."),setTimeout(()=>{f.workerMessenger.listen(),f.setupMessageListeners()},0)}static async getAppId(){if(self.location.search){const t=self.location.search.match(/appId=([0-9a-z-]+)&?/i);if(t&&t.length>1)return t[1]}const{appId:e}=await l.getAppConfig();return e}static setupMessageListeners(){f.workerMessenger.on(P.WorkerVersion,()=>{h.debug("[Service Worker] Received worker version message."),f.workerMessenger.broadcast(P.WorkerVersion,O.version())}),f.workerMessenger.on(P.Subscribe,async e=>{const t=e;h.debug("[Service Worker] Received subscribe message.");const i=new ft(t),n=await i.subscriptionManager.subscribe(Se.ResubscribeExisting),a=await i.subscriptionManager.registerSubscription(n);f.workerMessenger.broadcast(P.Subscribe,a.serialize())}),f.workerMessenger.on(P.SubscribeNew,async e=>{const t=e;h.debug("[Service Worker] Received subscribe new message.");const i=new ft(t),n=await i.subscriptionManager.subscribe(Se.SubscribeNew),a=await i.subscriptionManager.registerSubscription(n);f.workerMessenger.broadcast(P.SubscribeNew,a.serialize())}),f.workerMessenger.on(P.AreYouVisibleResponse,async e=>{h.debug("[Service Worker] Received response for AreYouVisible",e);const t=e.timestamp;self.clientsStatus?.timestamp===t&&(self.clientsStatus.receivedResponsesCount++,e.focused&&(self.clientsStatus.hasAnyActiveSessions=!0))}),f.workerMessenger.on(P.SetLogging,async e=>{e.shouldLog?self.shouldLog=!0:self.shouldLog=void 0})}static onPushReceived(e){h.debug(`Called onPushReceived(${JSON.stringify(e,null,4)}):`,e),e.waitUntil(f.parseOrFetchNotifications(e).then(async t=>{const i=[],n=[],a=await f.getAppId();for(const o of t){h.debug("Raw Notification from OneSignal:",o);const r=Rt.toOSNotification(o);n.push(l.putNotificationReceivedForOutcomes(a,r)),i.push((async p=>{const u={notification:p};await f.workerMessenger.broadcast(P.NotificationWillDisplay,u).catch(m=>h.error(m));const d=await f.getPushSubscriptionId();return f.webhookNotificationEventSender.willDisplay(p,d),f.displayNotification(p).then(()=>f.sendConfirmedDelivery(p)).catch(m=>h.error(m))}).bind(null,r))}return i.reduce((o,r)=>o=o.then(r),Promise.resolve())}).catch(t=>{h.debug("Failed to display a notification:",t)}))}static async sendConfirmedDelivery(e){if(!e)return;if(!f.browserSupportsConfirmedDelivery())return null;if(!e.confirmDelivery)return;const t=await f.getAppId(),i=await this.getPushSubscriptionId();if(!!!(t&&e.notificationId))return;const a={player_id:i,app_id:t,device_type:X.getDeviceType()};h.debug(`Called sendConfirmedDelivery(${JSON.stringify(e,null,4)})`),await ct(Math.floor(Math.random()*Ai*1e3)),await I.put(`notifications/${e.notificationId}/report_received`,a)}static browserSupportsConfirmedDelivery(){return V().name!=="safari"}static async getWindowClients(){return await self.clients.matchAll({type:"window",includeUncontrolled:!0})}static async updateSessionBasedOnHasActive(e,t,i){if(t)await F.upsertSession(i.appId,i.onesignalId,i.subscriptionId,i.sessionThreshold,i.enableSessionDuration,i.sessionOrigin,i.outcomesConfig);else{const n=await F.deactivateSession(i.appId,i.onesignalId,i.subscriptionId,i.sessionThreshold,i.enableSessionDuration,i.outcomesConfig);n&&(self.cancel=n.cancel,e.waitUntil(n.promise))}}static async refreshSession(e,t){h.debug("[Service Worker] refreshSession");const i=await this.getWindowClients();if(t.isSafari)await f.checkIfAnyClientsFocusedAndUpdateSession(e,i,t);else{const n=i.some(a=>a.focused);h.debug("[Service Worker] hasAnyActiveSessions",n),await f.updateSessionBasedOnHasActive(e,n,t)}}static async checkIfAnyClientsFocusedAndUpdateSession(e,t,i){const n=new Date().getTime();self.clientsStatus={timestamp:n,sentRequestsCount:0,receivedResponsesCount:0,hasAnyActiveSessions:!1};const a={timestamp:n};t.forEach(p=>{self.clientsStatus.sentRequestsCount++,p.postMessage({command:P.AreYouVisible,payload:a})});const r=$e(async()=>{h.debug("updateSessionBasedOnHasActive",self.clientsStatus),await f.updateSessionBasedOnHasActive(e,self.clientsStatus.hasAnyActiveSessions,i),self.clientsStatus=void 0},.5);self.cancel=r.cancel,e.waitUntil(r.promise)}static debounceRefreshSession(e,t){h.debug("[Service Worker] debounceRefreshSession",t),self.cancel&&(self.cancel(),self.cancel=void 0);const n=$e(async()=>{await f.refreshSession(e,t)},1);self.cancel=n.cancel,e.waitUntil(n.promise)}static ensureImageResourceHttps(e){if(e)try{const t=new URL(e);return t.hostname==="localhost"||t.hostname.indexOf("192.168")!==-1||t.hostname==="127.0.0.1"||t.protocol==="https:"?e:t.hostname==="i0.wp.com"||t.hostname==="i1.wp.com"||t.hostname==="i2.wp.com"||t.hostname==="i3.wp.com"?`https://${t.hostname}${t.pathname}`:`https://i0.wp.com/${t.host+t.pathname}`}catch(t){h.error("ensureImageResourceHttps: ",t)}}static ensureNotificationResourcesHttps(e){if(e&&(e.icon&&(e.icon=f.ensureImageResourceHttps(e.icon)),e.image&&(e.image=f.ensureImageResourceHttps(e.image)),e.actionButtons&&e.actionButtons.length>0))for(const t of e.actionButtons)t.icon&&(t.icon=f.ensureImageResourceHttps(t.icon))}static async displayNotification(e){h.debug(`Called displayNotification(${JSON.stringify(e,null,4)}):`,e);const t=await f._getTitle(),i=await l.get("Options","defaultIcon"),n=await l.get("Options","persistNotification"),a=await f.getAppId();e.title=e.title?e.title:t,e.icon=e.icon?e.icon:i||void 0,f.ensureNotificationResourcesHttps(e);const o={body:e.body,icon:e.icon,image:e.image,data:e,actions:ki.toNative(e.actionButtons),tag:e.topic||a,requireInteraction:n!==!1,renotify:!0,badge:e.badgeIcon};await self.registration.showNotification(e.title,o),this.requiresMacOS15ChromiumAfterDisplayWorkaround()&&await ct(1e3)}static requiresMacOS15ChromiumAfterDisplayWorkaround(){const e=navigator.userAgentData,t=e?.platform==="macOS",i=!!e?.brands?.some(n=>n.brand==="Chromium");return t&&i}static shouldOpenNotificationUrl(e){return e!=="javascript:void(0);"&&e!=="do_not_open"&&!b.contains(e,"_osp=do_not_open")}static async onNotificationClosed(e){h.debug(`Called onNotificationClosed(${JSON.stringify(e,null,4)}):`,e);const t=e.notification.data;f.workerMessenger.broadcast(P.NotificationDismissed,t).catch(n=>h.error(n));const i=await f.getPushSubscriptionId();f.webhookNotificationEventSender.dismiss(t,i)}static async getNotificationUrlToOpen(e,t){if(t){const n=e?.actionButtons?.find(a=>a.actionId===t);if(n?.launchURL&&n.launchURL!=="")return n.launchURL}if(e.launchURL&&e.launchURL!=="")return e.launchURL;const{defaultNotificationUrl:i}=await l.getAppState();return i||location.origin}static async onNotificationClicked(e){h.debug(`Called onNotificationClicked(${JSON.stringify(e,null,4)}):`,e),e.notification.close();const t=e.notification.data;let i="exact",n="navigate";const a=await l.get("Options","notificationClickHandlerMatch");a&&(i=a);const o=await this.database.get("Options","notificationClickHandlerAction");o&&(n=o);const r=await f.getNotificationUrlToOpen(t,e.action),p=f.shouldOpenNotificationUrl(r),u=await f.getAppId(),d=X.getDeviceType(),m={notification:t,result:{actionId:e.action,url:r},timestamp:new Date().getTime()};h.info("NotificationClicked",m);const y=(async E=>{try{const B=await l.getCurrentSession();if(B&&B.status===ce.Active)return;await l.putNotificationClickedForOutcomes(u,E),B&&(B.notificationId=E.notification.notificationId,await l.upsertSession(B))}catch(B){h.error("Failed to save clicked notification.",B)}})(m),T=await this.getPushSubscriptionId(),C=f.sendConvertedAPIRequests(u,T,m,d),qe=await f.getWindowClients();let Ge=!1;for(const E of qe){const B=E.url;let Oe="";try{Oe=new URL(B).origin}catch(H){h.error("Failed to get the HTTP site's actual origin:",H)}let Ie=null;try{Ie=new URL(r).origin}catch(H){h.error("Failed parse launchUrl:",H)}if(i==="exact"&&B===r||i==="origin"&&Oe===Ie){if(E.url===r||n==="focus"&&Oe===Ie){f.workerMessenger.unicast(P.NotificationClicked,m,E);try{E instanceof WindowClient&&await E.focus()}catch(H){h.error("Failed to focus:",E,H)}}else if(E instanceof WindowClient&&E.navigate){try{h.debug("Client is standard HTTPS site. Attempting to focus() client."),E instanceof WindowClient&&await E.focus()}catch(H){h.error("Failed to focus:",E,H)}try{p?(h.debug(`Redirecting HTTPS site to (${r}).`),await l.putNotificationClickedEventPendingUrlOpening(m),await E.navigate(r)):h.debug("Not navigating because link is special.")}catch(H){h.error("Failed to navigate:",E,r,H)}}else await l.putNotificationClickedEventPendingUrlOpening(m),await f.openUrl(r);Ge=!0;break}}return p&&!Ge&&(await l.putNotificationClickedEventPendingUrlOpening(m),await f.openUrl(r)),y&&await y,await C}static async sendConvertedAPIRequests(e,t,i,n){const a=i.notification;if(!a.notificationId){console.error("No notification id, skipping networks calls to report open!");return}let o;e?o=I.put(`notifications/${a.notificationId}`,{app_id:e,player_id:t,opened:!0,device_type:n}):console.error("No app Id, skipping OneSignal API call for notification open!"),await f.webhookNotificationEventSender.click(i,t),o&&await o}static async openUrl(e){h.debug("Opening notification URL:",e);try{return await self.clients.openWindow(e)}catch(t){return h.warn(`Failed to open the URL '${e}':`,t),null}}static onServiceWorkerActivated(e){h.info(`OneSignal Service Worker activated (version ${O.version()})`),e.waitUntil(self.clients.claim())}static async onPushSubscriptionChange(e){h.debug(`Called onPushSubscriptionChange(${JSON.stringify(e,null,4)}):`,e);const t=await f.getAppId();if(!t)return;const i=await Oi.getAppConfig({appId:t},He.downloadServerAppConfig);if(!i)return;const n=new ft(i);let a;{let u=(await l.getSubscription()).deviceId;if(a=!!u,!a&&e.oldSubscription){u=await He.getUserIdFromSubscriptionIdentifier(t,X.getDeviceType(),e.oldSubscription.endpoint);const d=await l.getSubscription();d.deviceId=u,await l.setSubscription(d)}a=!!u}let o;const r=e.newSubscription;if(r)o=oe.setFromW3cSubscription(r);else try{o=await n.subscriptionManager.subscribe(Se.SubscribeNew)}catch{}if(!a&&!!!o)await l.remove("Ids","userId"),await l.remove("Ids","registrationId");else{let u=null;Notification.permission!=="granted"?u=j.PermissionRevoked:o||(u=j.PushSubscriptionRevoked),await n.subscriptionManager.registerSubscription(o,u)}}static _getTitle(){return new Promise(e=>{Promise.all([l.get("Options","defaultTitle"),l.get("Options","pageTitle")]).then(([t,i])=>{t!==null?e(t):i!=null?e(i):e("")})})}static parseOrFetchNotifications(e){if(!e||!e.data)return Promise.reject("Missing event.data on push payload!");if(f.isValidPushPayload(e.data)){h.debug("Received a valid encrypted push payload.");const i=e.data.json();return Promise.resolve([i])}return Promise.reject(`Unexpected push message payload received: ${e.data}`)}static isValidPushPayload(e){try{const t=e.json();return Rt.isValid(t)?!0:(h.debug("isValidPushPayload: Valid JSON but missing notification UUID:",t),!1)}catch(t){return h.debug("isValidPushPayload: Parsing to JSON failed with:",t),!1}}}typeof self>"u"&&typeof global<"u"?global.OneSignalWorker=f:self.OneSignalWorker=f,typeof self<"u"&&f.run(),self.OneSignal=f})();
//# sourceMappingURL=OneSignalSDK.sw.js.map
